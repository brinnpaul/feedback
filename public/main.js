'use strict';

window.app = angular.module('MyApp', ['ui.router', 'ui.bootstrap', 'ngAnimate', 'ngKookies']);

app.config(function ($urlRouterProvider, $locationProvider, $kookiesProvider) {
  // This turns off hashbang urls (/#about) and changes it to something normal (/about)
  $locationProvider.html5Mode(true);
  // If we go to a URL that ui-router doesn't have registered, go to the "/" url.
  $urlRouterProvider.otherwise('/');
  // Trigger page refresh when accessing an OAuth route
  $urlRouterProvider.when('/auth/:provider', function () {
    window.location.reload();
  });

  $kookiesProvider.config.json = true;
});

app.config(function ($stateProvider) {
  $stateProvider.state('student', {
    url: '/student',
    templateUrl: 'js/views/student/student.html'
  });
});

app.config(function ($stateProvider) {
  $stateProvider.state('admin', {
    url: '/admin',
    templateUrl: 'js/views/instructor/instructor.html'
  });
});

app.controller('LoginCtrl', function ($scope, $state) {

  console.log("reached login ctrl");
  $scope.loginStatus = function () {
    console.log("reached login status");
    var temp = $scope.login;
    console.log("temp: ", temp);

    if (temp === 'admin') {
      $state.go('admin');
    } else if (temp === 'student') {
      $state.go('student');
    }
  };
});

var socket = io(window.location.origin);

socket.on('connect', function () {});
app.controller('CreatePoll', function ($scope, $uibModal) {

  $scope.showModal = function () {

    $scope.opts = {
      backdrop: true,
      backdropClick: true,
      transclude: true,
      dialogFade: false,
      keyboard: true,
      templateUrl: 'js/common/createPollModal/createPollModal.html',
      controller: ModalInstanceCtrl,
      resolve: {} // empty storage
    };

    $scope.opts.resolve.item = function () {
      return angular.copy({ polls: $scope.polls }); // pass name to Dialog
    };

    var modalInstance = $uibModal.open($scope.opts);

    modalInstance.result.then(function () {
      //on ok button press
    }, function () {
      //on cancel button press
      console.log("Modal Closed");
    });
  };
});

var ModalInstanceCtrl = function ModalInstanceCtrl($scope, $uibModalInstance, $uibModal, item, PollFactory) {

  $scope.item = item;

  $scope.customOptions = function (option) {
    $scope.customShow = option === 'custom';
  };

  $scope.submitPoll = function () {
    var poll = {};
    poll.question = $scope.newPoll;
    poll.lectureId = 1;
    if ($scope.option == 'custom') poll.options = [$scope.a, $scope.b, $scope.c, $scope.d];

    PollFactory.createPoll(poll).then(function () {
      return PollFactory.getAllByLectureId(1);
    }).then(function (polls) {
      $scope.polls = polls;
    }).then(function () {
      $uibModalInstance.close();
    });
  };

  $scope.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };
};

app.directive('feedback', function ($state, FeedbackFactory) {
  return {
    restrict: 'E',
    scope: {},
    templateUrl: 'js/common/feedback/feedback.html',
    link: function link(scope) {
      scope.addMessage = false;

      scope.countFeedback = function (category) {
        return FeedbackFactory.addFeedback(category).then(function () {
          return FeedbackFactory.countFeedback(category);
        }).then(function (result) {
          console.log('IT IS HERE', result);
          if (category === 'Great') {
            scope.greatCount = result;
          }
          if (category === 'Confused') {
            scope.confusedCount = result;
          }
          if (category === 'Example') {
            scope.exampleCount = result;
          }
        }).then(function () {
          scope.addMessage = true;
          setTimeout(function () {
            scope.addMessage = false;
            scope.$digest();
          }, 1000);
        }).then(function () {
          setTimeout(function () {
            scope.greatCount = null;
            scope.confusedCount = null;
            scope.exampleCount = null;
            scope.$digest();
          }, 30 * 1000);
        });
      };
    }
  };
});

app.factory('FeedbackFactory', function ($http) {
  var FeedbackFactory = {};

  FeedbackFactory.addFeedback = function (category) {
    return $http.post('/api/feedback/', { category: category }).then(function (result) {
      console.log('gotHERE', result);
    });
  };

  FeedbackFactory.countFeedback = function (category) {
    return $http.get('/api/feedback/count/' + category).then(function (result) {
      return result.data;
    });
  };

  return FeedbackFactory;
});
app.directive('poll', function ($state, PollFactory) {
  return {
    restrict: 'E',
    scope: {
      useCtrl: "@"
    },
    templateUrl: 'js/common/poll/poll.html',
    link: function link(scope) {

      scope.delete = PollFactory.deletePoll;

      PollFactory.getAllByLectureId(1).then(function (currentPolls) {
        scope.polls = currentPolls;
      });
    }
  };
});

app.factory('PollFactory', function ($http) {
  function dotData(dot) {
    return dot.data;
  }
  var cachedPolls = [];
  return {
    getAllByLectureId: function getAllByLectureId(id) {
      return $http.get('/api/poll/lecture/' + id).then(dotData).then(function (polls) {
        angular.copy(polls, cachedPolls);
        return cachedPolls;
      });
    },
    getOneByPollId: function getOneByPollId(id) {
      return $http.get('/api/poll/' + id).then(dotData);
    },
    createPoll: function createPoll(pollObj) {
      return $http.post('/api/poll/', pollObj).then(dotData);
    },
    updatePoll: function updatePoll(pollObj, id) {
      return $http.put('/api/poll/' + id, pollObj).then(dotData);
    },
    deletePoll: function deletePoll(id) {
      return $http.delete('/api/poll/' + id).then(dotData).then(function (removedPoll) {
        cachedPolls.splice(cachedPolls.map(function (item) {
          return item.id;
        }).indexOf(id), 1);
        return cachedPolls;
      });
    }
  };
});

app.directive('question', function ($state, QuestionFactory) {

  return {
    restrict: 'E',
    scope: {},
    templateUrl: 'js/common/question/question.html',
    link: function link(scope) {
      QuestionFactory.getAllByLectureId(1).then(function (questions) {
        scope.questions = questions.filter(function (q) {
          return q.status === 'open';
        }).map(function (q) {
          return q.hasUpvoted = false;
        });
      });

      function findIndex(question) {
        for (var i = 0; i < scope.questions.length; i++) {
          if (scope.questions[i].text === question.text) {
            return i;
          }
        }
        return -1;
      }

      scope.submit = function () {
        if (scope.newQuestion) {
          var question = { text: scope.newQuestion, submitTime: Date.now(), upvotes: 0 };
          socket.emit('addingQuestion', question);
          scope.newQuestion = null;
        }
      };

      scope.delete = function (question) {
        socket.emit('deletingQuestion', question);
      };

      scope.store = function (question, status) {
        question.status = status;
        QuestionFactory.store(question).then(function () {
          scope.delete(question);
        });
      };

      scope.upvote = function (question) {
        socket.emit('upvoting', question);
        question.hasUpvoted = !question.hasUpvoted;
      };

      scope.downvote = function (question) {
        socket.emit('downvoting', question);
        question.hasUpvoted = !question.hasUpvoted;
      };

      socket.on('addQuestion', function (question) {
        scope.questions.unshift(question);
        scope.$evalAsync();
      });

      socket.on('deleteQuestion', function (question) {
        var index = findIndex(question);
        scope.questions.splice(index, 1);
        scope.$evalAsync();
      });

      socket.on('receivedUpvote', function (question) {
        var index = findIndex(question);
        var q = scope.questions[index];
        q.upvotes ? q.upvotes++ : q.upvotes = 1;
        scope.$evalAsync();
      });

      socket.on('receivedDownvote', function (question) {
        var index = findIndex(question);
        var q = scope.questions[index];
        q.upvotes--;
        scope.$evalAsync();
      });
    }
  };
});

app.factory('QuestionFactory', function ($http) {

  var obj = {};

  obj.getAllByLectureId = function (lectureId) {
    return $http.get('/api/question/lecture/' + lectureId).then(function (res) {
      return res.data;
    });
  };

  obj.store = function (question) {
    return $http.post('/api/question', question).then(function (res) {
      return res.data;
    });
  };

  return obj;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsInNvY2tldC5qcyIsImNvbW1vbi9jcmVhdGVQb2xsTW9kYWwvY3JlYXRlUG9sbC5jb250cm9sbGVyLmpzIiwiY29tbW9uL2ZlZWRiYWNrL2ZlZWRiYWNrLmRpcmVjdGl2ZS5qcyIsImNvbW1vbi9mZWVkYmFjay9mZWVkYmFjay5mYWN0b3J5LmpzIiwiY29tbW9uL3BvbGwvcG9sbC5kaXJlY3RpdmUuanMiLCJjb21tb24vcG9sbC9wb2xsLmZhY3RvcnkuanMiLCJjb21tb24vcXVlc3Rpb24vcXVlc3Rpb24uZGlyZWN0aXZlLmpzIiwiY29tbW9uL3F1ZXN0aW9uL3F1ZXN0aW9uLmZhY3RvcnkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsT0FBQSxHQUFBLEdBQUEsUUFBQSxNQUFBLENBQUEsT0FBQSxFQUFBLENBQUEsV0FBQSxFQUFBLGNBQUEsRUFBQSxXQUFBLEVBQUEsV0FBQSxDQUFBLENBQUE7O0FBRUEsSUFBQSxNQUFBLENBQUEsVUFBQSxrQkFBQSxFQUFBLGlCQUFBLEVBQUEsZ0JBQUEsRUFBQTs7QUFFQSxvQkFBQSxTQUFBLENBQUEsSUFBQTs7QUFFQSxxQkFBQSxTQUFBLENBQUEsR0FBQTs7QUFFQSxxQkFBQSxJQUFBLENBQUEsaUJBQUEsRUFBQSxZQUFBO0FBQ0EsV0FBQSxRQUFBLENBQUEsTUFBQTtBQUNBLEdBRkE7O0FBSUEsbUJBQUEsTUFBQSxDQUFBLElBQUEsR0FBQSxJQUFBO0FBRUEsQ0FaQTs7QUFjQSxJQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGlCQUFBLEtBQUEsQ0FBQSxTQUFBLEVBQUE7QUFDQSxTQUFBLFVBREE7QUFFQSxpQkFBQTtBQUZBLEdBQUE7QUFJQSxDQUxBOztBQU9BLElBQUEsTUFBQSxDQUFBLFVBQUEsY0FBQSxFQUFBO0FBQ0EsaUJBQUEsS0FBQSxDQUFBLE9BQUEsRUFBQTtBQUNBLFNBQUEsUUFEQTtBQUVBLGlCQUFBO0FBRkEsR0FBQTtBQUlBLENBTEE7O0FB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aUJBQUEsRUFBQSxVQUFBLEdBQUEsS0FBQTtBQUNBLFNBSkEsQ0FBQTtBQUtBLE9BTkE7O0FBUUEsZUFBQSxTQUFBLENBQUEsUUFBQSxFQUFBO0FBQ0EsYUFBQSxJQUFBLElBQUEsQ0FBQSxFQUFBLElBQUEsTUFBQSxTQUFBLENBQUEsTUFBQSxFQUFBLEdBQUEsRUFBQTtBQUNBLGNBQUEsTUFBQSxTQUFBLENBQUEsQ0FBQSxFQUFBLElBQUEsS0FBQSxTQUFBLElBQUEsRUFBQTtBQUNBLG1CQUFBLENBQUE7QUFDQTtBQUNBO0FBQ0EsZUFBQSxDQUFBLENBQUE7QUFDQTs7QUFFQSxZQUFBLE1BQUEsR0FBQSxZQUFBO0FBQ0EsWUFBQSxNQUFBLFdBQUEsRUFBQTtBQUNBLGNBQUEsV0FBQSxFQUFBLE1BQUEsTUFBQSxXQUFBLEVBQUEsWUFBQSxLQUFBLEdBQUEsRUFBQSxFQUFBLFNBQUEsQ0FBQSxFQUFBO0FBQ0EsaUJBQUEsSUFBQSxDQUFBLGdCQUFBLEVBQUEsUUFBQTtBQUNBLGdCQUFBLFdBQUEsR0FBQSxJQUFBO0FBQ0E7QUFDQSxPQU5BOztBQVFBLFlBQUEsTUFBQSxHQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsZUFBQSxJQUFBLENBQUEsa0JBQUEsRUFBQSxRQUFBO0FBQ0EsT0FGQTs7QUFJQSxZQUFBLEtBQUEsR0FBQSxVQUFBLFFBQUEsRUFBQSxNQUFBLEVBQUE7QUFDQSxpQkFBQSxNQUFBLEdBQUEsTUFBQTtBQUNBLHdCQUFBLEtBQUEsQ0FBQSxRQUFBLEVBQUEsSUFBQSxDQUFBLFlBQUE7QUFDQSxnQkFBQSxNQUFBLENBQUEsUUFBQTtBQUNBLFNBRkE7QUFHQSxPQUxBOztBQU9BLFlBQUEsTUFBQSxHQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsZUFBQSxJQUFBLENBQUEsVUFBQSxFQUFBLFFBQUE7QUFDQSxpQkFBQSxVQUFBLEdBQUEsQ0FBQSxTQUFBLFVBQUE7QUFDQSxPQUhBOztBQUtBLFlBQUEsUUFBQSxHQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsZUFBQSxJQUFBLENBQUEsWUFBQSxFQUFBLFFBQUE7QUFDQSxpQkFBQSxVQUFBLEdBQUEsQ0FBQSxTQUFBLFVBQUE7QUFDQSxPQUhBOztBQUtBLGFBQUEsRUFBQSxDQUFBLGFBQUEsRUFBQSxVQUFBLFFBQUEsRUFBQTtBQUNBLGNBQUEsU0FBQSxDQUFBLE9BQUEsQ0FBQSxRQUFBO0FBQ0EsY0FBQSxVQUFBO0FBQ0EsT0FIQTs7QUFLQSxhQUFBLEVBQUEsQ0FBQSxnQkFBQSxFQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsWUFBQSxRQUFBLFVBQUEsUUFBQSxDQUFBO0FBQ0EsY0FBQSxTQUFBLENBQUEsTUFBQSxDQUFBLEtBQUEsRUFBQSxDQUFBO0FBQ0EsY0FBQSxVQUFBO0FBQ0EsT0FKQTs7QUFNQSxhQUFBLEVBQUEsQ0FBQSxnQkFBQSxFQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsWUFBQSxRQUFBLFVBQUEsUUFBQSxDQUFBO0FBQ0EsWUFBQSxJQUFBLE1BQUEsU0FBQSxDQUFBLEtBQUEsQ0FBQTtBQUNBLFVBQUEsT0FBQSxHQUFBLEVBQUEsT0FBQSxFQUFBLEdBQUEsRUFBQSxPQUFBLEdBQUEsQ0FBQTtBQUNBLGNBQUEsVUFBQTtBQUNBLE9BTEE7O0FBT0EsYUFBQSxFQUFBLENBQUEsa0JBQUEsRUFBQSxVQUFBLFFBQUEsRUFBQTtBQUNBLFlBQUEsUUFBQSxVQUFBLFFBQUEsQ0FBQTtBQUNBLFlBQUEsSUFBQSxNQUFBLFNBQUEsQ0FBQSxLQUFBLENBQUE7QUFDQSxVQUFBLE9BQUE7QUFDQSxjQUFBLFVBQUE7QUFDQSxPQUxBO0FBTUE7QUE3RUEsR0FBQTtBQStFQSxDQWpGQTs7QUNBQSxJQUFBLE9BQUEsQ0FBQSxpQkFBQSxFQUFBLFVBQUEsS0FBQSxFQUFBOztBQUVBLE1BQUEsTUFBQSxFQUFBOztBQUVBLE1BQUEsaUJBQUEsR0FBQSxVQUFBLFNBQUEsRUFBQTtBQUNBLFdBQUEsTUFBQSxHQUFBLENBQUEsMkJBQUEsU0FBQSxFQUFBLElBQUEsQ0FBQSxVQUFBLEdBQUEsRUFBQTtBQUNBLGFBQUEsSUFBQSxJQUFBO0FBQ0EsS0FGQSxDQUFBO0FBR0EsR0FKQTs7QUFNQSxNQUFBLEtBQUEsR0FBQSxVQUFBLFFBQUEsRUFBQTtBQUNBLFdBQUEsTUFBQSxJQUFBLENBQUEsZUFBQSxFQUFBLFFBQUEsRUFBQSxJQUFBLENBQUEsVUFBQSxHQUFBLEVBQUE7QUFDQSxhQUFBLElBQUEsSUFBQTtBQUNBLEtBRkEsQ0FBQTtBQUdBLEdBSkE7O0FBTUEsU0FBQSxHQUFBO0FBRUEsQ0FsQkEiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0Jztcblxud2luZG93LmFwcCA9IGFuZ3VsYXIubW9kdWxlKCdNeUFwcCcsIFsndWkucm91dGVyJywgJ3VpLmJvb3RzdHJhcCcsICduZ0FuaW1hdGUnLCAnbmdLb29raWVzJ10pO1xuXG5hcHAuY29uZmlnKGZ1bmN0aW9uICgkdXJsUm91dGVyUHJvdmlkZXIsICRsb2NhdGlvblByb3ZpZGVyLCAka29va2llc1Byb3ZpZGVyKSB7XG4gICAgLy8gVGhpcyB0dXJucyBvZmYgaGFzaGJhbmcgdXJscyAoLyNhYm91dCkgYW5kIGNoYW5nZXMgaXQgdG8gc29tZXRoaW5nIG5vcm1hbCAoL2Fib3V0KVxuICAgICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTtcbiAgICAvLyBJZiB3ZSBnbyB0byBhIFVSTCB0aGF0IHVpLXJvdXRlciBkb2Vzbid0IGhhdmUgcmVnaXN0ZXJlZCwgZ28gdG8gdGhlIFwiL1wiIHVybC5cbiAgICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKCcvJyk7XG4gICAgLy8gVHJpZ2dlciBwYWdlIHJlZnJlc2ggd2hlbiBhY2Nlc3NpbmcgYW4gT0F1dGggcm91dGVcbiAgICAkdXJsUm91dGVyUHJvdmlkZXIud2hlbignL2F1dGgvOnByb3ZpZGVyJywgZnVuY3Rpb24gKCkge1xuICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XG4gICAgfSk7XG5cbiAgICAka29va2llc1Byb3ZpZGVyLmNvbmZpZy5qc29uID0gdHJ1ZTtcblxufSk7XG5cbmFwcC5jb25maWcoZnVuY3Rpb24gKCRzdGF0ZVByb3ZpZGVyKSB7XG4gICAgJHN0YXRlUHJvdmlkZXIuc3RhdGUoJ3N0dWRlbnQnLCB7XG4gICAgICAgIHVybDogJy9zdHVkZW50JyxcbiAgICAgICAgdGVtcGxhdGVVcmw6ICdqcy92aWV3cy9zdHVkZW50L3N0dWRlbnQuaHRtbCcsXG4gICAgfSk7XG59KTtcblxuYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIpIHtcbiAgICAkc3RhdGVQcm92aWRlci5zdGF0ZSgnYWRtaW4nLCB7XG4gICAgICAgIHVybDogJy9hZG1pbicsXG4gICAgICAgIHRlbXBsYXRlVXJsOiAnanMvdmlld3MvaW5zdHJ1Y3Rvci9pbnN0cnVjdG9yLmh0bWwnLFxuICAgIH0pO1xufSk7XG5cbmFwcC5jb250cm9sbGVyKCdMb2dpbkN0cmwnLCBmdW5jdGlvbiAoJHNjb3BlLCAkc3RhdGUpIHtcblxuXHRjb25zb2xlLmxvZyhcInJlYWNoZWQgbG9naW4gY3RybFwiKTtcblx0JHNjb3BlLmxvZ2luU3RhdHVzID0gZnVuY3Rpb24oKXtcblx0XHRjb25zb2xlLmxvZyhcInJlYWNoZWQgbG9naW4gc3RhdHVzXCIpO1xuXHRcdHZhciB0ZW1wID0gJHNjb3BlLmxvZ2luO1xuXHRcdGNvbnNvbGUubG9nKFwidGVtcDogXCIsdGVtcCk7XG5cblx0XHRpZiAodGVtcD09PSdhZG1pbicpe1xuXHRcdFx0JHN0YXRlLmdvKCdhZG1pbicpO1xuXHRcdH1cblx0XHRlbHNlIGlmICh0ZW1wPT09J3N0dWRlbnQnKXtcblx0XHRcdCRzdGF0ZS5nbygnc3R1ZGVudCcpO1xuXHRcdH1cblx0fVxuXG59KTtcbiIsInZhciBzb2NrZXQgPSBpbyh3aW5kb3cubG9jYXRpb24ub3JpZ2luKTtcblxuc29ja2V0Lm9uKCdjb25uZWN0JywgZnVuY3Rpb24oKSB7XG4gICAgXG59KSIsImFwcC5jb250cm9sbGVyKCdDcmVhdGVQb2xsJywgZnVuY3Rpb24oJHNjb3BlLCAkdWliTW9kYWwpIHtcblxuICAkc2NvcGUuc2hvd01vZGFsID0gZnVuY3Rpb24oKSB7XG5cbiAgICAkc2NvcGUub3B0cyA9IHtcbiAgICBiYWNrZHJvcDogdHJ1ZSxcbiAgICBiYWNrZHJvcENsaWNrOiB0cnVlLFxuICAgIHRyYW5zY2x1ZGU6IHRydWUsXG4gICAgZGlhbG9nRmFkZTogZmFsc2UsXG4gICAga2V5Ym9hcmQ6IHRydWUsXG4gICAgdGVtcGxhdGVVcmwgOiAnanMvY29tbW9uL2NyZWF0ZVBvbGxNb2RhbC9jcmVhdGVQb2xsTW9kYWwuaHRtbCcsXG4gICAgY29udHJvbGxlciA6IE1vZGFsSW5zdGFuY2VDdHJsLFxuICAgIHJlc29sdmU6IHt9IC8vIGVtcHR5IHN0b3JhZ2VcbiAgICAgIH07XG5cbiAgICAkc2NvcGUub3B0cy5yZXNvbHZlLml0ZW0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIGFuZ3VsYXIuY29weSh7cG9sbHM6JHNjb3BlLnBvbGxzfSk7IC8vIHBhc3MgbmFtZSB0byBEaWFsb2dcbiAgICB9XG5cbiAgICAgIHZhciBtb2RhbEluc3RhbmNlID0gJHVpYk1vZGFsLm9wZW4oJHNjb3BlLm9wdHMpO1xuXG4gICAgICBtb2RhbEluc3RhbmNlLnJlc3VsdC50aGVuKGZ1bmN0aW9uKCl7XG4gICAgICAgIC8vb24gb2sgYnV0dG9uIHByZXNzXG4gICAgICB9LGZ1bmN0aW9uKCl7XG4gICAgICAgIC8vb24gY2FuY2VsIGJ1dHRvbiBwcmVzc1xuICAgICAgICBjb25zb2xlLmxvZyhcIk1vZGFsIENsb3NlZFwiKTtcbiAgICAgIH0pXG4gIH1cblxufSlcblxudmFyIE1vZGFsSW5zdGFuY2VDdHJsID0gZnVuY3Rpb24oJHNjb3BlLCAkdWliTW9kYWxJbnN0YW5jZSwgJHVpYk1vZGFsLCBpdGVtLCBQb2xsRmFjdG9yeSkge1xuXG4gICRzY29wZS5pdGVtID0gaXRlbTtcblxuICAkc2NvcGUuY3VzdG9tT3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbikge1xuICAgICRzY29wZS5jdXN0b21TaG93ID0gKG9wdGlvbiA9PT0gJ2N1c3RvbScpXG4gIH1cblxuICAkc2NvcGUuc3VibWl0UG9sbCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcG9sbCA9IHt9XG4gICAgcG9sbC5xdWVzdGlvbiA9ICRzY29wZS5uZXdQb2xsXG4gICAgcG9sbC5sZWN0dXJlSWQgPSAxXG4gICAgaWYgKCRzY29wZS5vcHRpb249PSdjdXN0b20nKSBwb2xsLm9wdGlvbnMgPSBbJHNjb3BlLmEsICRzY29wZS5iLCAkc2NvcGUuYywgJHNjb3BlLmRdXG5cbiAgICBQb2xsRmFjdG9yeS5jcmVhdGVQb2xsKHBvbGwpXG4gICAgLnRoZW4oKCkgPT4geyByZXR1cm4gUG9sbEZhY3RvcnkuZ2V0QWxsQnlMZWN0dXJlSWQoMSkgfSlcbiAgICAudGhlbigocG9sbHMpID0+IHsgJHNjb3BlLnBvbGxzID0gcG9sbHMgfSlcbiAgICAudGhlbigoKSA9PiB7ICR1aWJNb2RhbEluc3RhbmNlLmNsb3NlKCkgfSlcbiAgfVxuXG4gICRzY29wZS5jYW5jZWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgJHVpYk1vZGFsSW5zdGFuY2UuZGlzbWlzcygnY2FuY2VsJyk7XG4gIH1cbn1cbiIsImFwcC5kaXJlY3RpdmUoJ2ZlZWRiYWNrJywgKCRzdGF0ZSwgRmVlZGJhY2tGYWN0b3J5KSA9PiB7XG4gIHJldHVybiB7XG4gICAgcmVzdHJpY3Q6ICdFJyxcbiAgICBzY29wZToge1xuXG4gICAgfSxcbiAgICB0ZW1wbGF0ZVVybDogJ2pzL2NvbW1vbi9mZWVkYmFjay9mZWVkYmFjay5odG1sJyxcbiAgICBsaW5rOiAoc2NvcGUpID0+IHtcbiAgICAgIHNjb3BlLmFkZE1lc3NhZ2UgPSBmYWxzZTtcblxuICAgICAgc2NvcGUuY291bnRGZWVkYmFjayA9IGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICByZXR1cm4gRmVlZGJhY2tGYWN0b3J5LmFkZEZlZWRiYWNrKGNhdGVnb3J5KVxuICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgcmV0dXJuIEZlZWRiYWNrRmFjdG9yeS5jb3VudEZlZWRiYWNrKGNhdGVnb3J5KVxuICAgICAgICB9KSBcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdJVCBJUyBIRVJFJywgcmVzdWx0KVxuICAgICAgICAgIGlmIChjYXRlZ29yeSA9PT0gJ0dyZWF0Jykge1xuICAgICAgICAgICAgc2NvcGUuZ3JlYXRDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdDb25mdXNlZCcpIHtcbiAgICAgICAgICAgIHNjb3BlLmNvbmZ1c2VkQ291bnQgPSByZXN1bHRcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGNhdGVnb3J5ID09PSAnRXhhbXBsZScpIHtcbiAgICAgICAgICAgIHNjb3BlLmV4YW1wbGVDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHNjb3BlLmFkZE1lc3NhZ2UgPSB0cnVlXG4gICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgICAgICAgc2NvcGUuYWRkTWVzc2FnZSA9IGZhbHNlO1xuICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpO1xuICAgICAgICAgIH0sIDEwMDApO1xuICAgICAgICB9KVxuICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHNjb3BlLmdyZWF0Q291bnQgPSBudWxsXG4gICAgICAgICAgICBzY29wZS5jb25mdXNlZENvdW50ID0gbnVsbFxuICAgICAgICAgICAgc2NvcGUuZXhhbXBsZUNvdW50ID0gbnVsbFxuICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpO1xuICAgICAgICAgIH0sIDMwKjEwMDApXG4gICAgICAgIH0pXG4gICAgICB9XG4gIH1cbn1cbn0pXG4iLCJhcHAuZmFjdG9yeSgnRmVlZGJhY2tGYWN0b3J5JywgZnVuY3Rpb24gKCRodHRwKSB7XG5cdHZhciBGZWVkYmFja0ZhY3RvcnkgPSB7fTtcblxuXHRGZWVkYmFja0ZhY3RvcnkuYWRkRmVlZGJhY2sgPSBmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcblx0XHRyZXR1cm4gJGh0dHAucG9zdCgnL2FwaS9mZWVkYmFjay8nLCB7Y2F0ZWdvcnk6IGNhdGVnb3J5fSlcblx0XHQudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcblx0XHRcdGNvbnNvbGUubG9nKCdnb3RIRVJFJywgcmVzdWx0KVxuXHRcdH0pXG5cdH1cblxuXHRGZWVkYmFja0ZhY3RvcnkuY291bnRGZWVkYmFjayA9IGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuXHRcdHJldHVybiAkaHR0cC5nZXQoJy9hcGkvZmVlZGJhY2svY291bnQvJysgY2F0ZWdvcnkpXG5cdFx0LnRoZW4oZnVuY3Rpb24ocmVzdWx0ICkge1xuXHRcdFx0cmV0dXJuIHJlc3VsdC5kYXRhXG5cdFx0fSlcblx0fVxuXG5cdHJldHVybiBGZWVkYmFja0ZhY3Rvcnlcbn0pIiwiYXBwLmRpcmVjdGl2ZSgncG9sbCcsICgkc3RhdGUsIFBvbGxGYWN0b3J5KSA9PiB7XG4gIHJldHVybiB7XG4gICAgcmVzdHJpY3Q6ICdFJyxcbiAgICBzY29wZToge1xuICAgICAgdXNlQ3RybDogXCJAXCJcbiAgICB9LFxuICAgIHRlbXBsYXRlVXJsOiAnanMvY29tbW9uL3BvbGwvcG9sbC5odG1sJyxcbiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSkge1xuXG4gICAgICBzY29wZS5kZWxldGUgPSBQb2xsRmFjdG9yeS5kZWxldGVQb2xsXG5cbiAgICAgIFBvbGxGYWN0b3J5LmdldEFsbEJ5TGVjdHVyZUlkKDEpXG4gICAgICAudGhlbigoY3VycmVudFBvbGxzKSA9PiB7XG4gICAgICAgIHNjb3BlLnBvbGxzID0gY3VycmVudFBvbGxzXG4gICAgICB9KVxuXG5cbiAgICB9XG4gIH1cbn0pXG4iLCJhcHAuZmFjdG9yeSgnUG9sbEZhY3RvcnknLCAoJGh0dHApID0+IHtcbiAgZnVuY3Rpb24gZG90RGF0YShkb3QpIHtcbiAgICByZXR1cm4gZG90LmRhdGFcbiAgfVxuICB2YXIgY2FjaGVkUG9sbHMgPSBbXVxuICByZXR1cm4ge1xuICAgIGdldEFsbEJ5TGVjdHVyZUlkOiAoaWQpID0+IHtcbiAgICAgIHJldHVybiAkaHR0cC5nZXQoJy9hcGkvcG9sbC9sZWN0dXJlLycraWQpXG4gICAgICAudGhlbihkb3REYXRhKVxuICAgICAgLnRoZW4oKHBvbGxzKSA9PiB7XG4gICAgICAgIGFuZ3VsYXIuY29weShwb2xscywgY2FjaGVkUG9sbHMpXG4gICAgICAgIHJldHVybiBjYWNoZWRQb2xsc1xuICAgICAgfSlcbiAgICB9LFxuICAgIGdldE9uZUJ5UG9sbElkOiAoaWQpID0+IHtcbiAgICAgIHJldHVybiAkaHR0cC5nZXQoJy9hcGkvcG9sbC8nK2lkKVxuICAgICAgLnRoZW4oZG90RGF0YSlcbiAgICB9LFxuICAgIGNyZWF0ZVBvbGw6IChwb2xsT2JqKSA9PiB7XG4gICAgICByZXR1cm4gJGh0dHAucG9zdCgnL2FwaS9wb2xsLycsIHBvbGxPYmopXG4gICAgICAudGhlbihkb3REYXRhKVxuICAgIH0sXG4gICAgdXBkYXRlUG9sbDogKHBvbGxPYmosIGlkKSA9PiB7XG4gICAgICByZXR1cm4gJGh0dHAucHV0KCcvYXBpL3BvbGwvJytpZCwgcG9sbE9iailcbiAgICAgIC50aGVuKGRvdERhdGEpXG4gICAgfSxcbiAgICBkZWxldGVQb2xsOiAoaWQpID0+IHtcbiAgICAgIHJldHVybiAkaHR0cC5kZWxldGUoJy9hcGkvcG9sbC8nK2lkKVxuICAgICAgLnRoZW4oZG90RGF0YSlcbiAgICAgIC50aGVuKChyZW1vdmVkUG9sbCkgPT4ge1xuICAgICAgICBjYWNoZWRQb2xscy5zcGxpY2UoY2FjaGVkUG9sbHMubWFwKGZ1bmN0aW9uKGl0ZW0pIHsgcmV0dXJuIGl0ZW0uaWQgfSkuaW5kZXhPZihpZCksMSlcbiAgICAgICAgcmV0dXJuIGNhY2hlZFBvbGxzXG4gICAgICB9KVxuICAgIH1cbiAgfVxufSlcbiIsImFwcC5kaXJlY3RpdmUoJ3F1ZXN0aW9uJywgZnVuY3Rpb24oJHN0YXRlLCBRdWVzdGlvbkZhY3RvcnkpIHtcblxuICAgIHJldHVybiB7XG4gICAgICAgIHJlc3RyaWN0OiAnRScsXG4gICAgICAgIHNjb3BlOiB7XG4gICAgICAgICAgICBcbiAgICAgICAgfSxcbiAgICAgICAgdGVtcGxhdGVVcmw6ICdqcy9jb21tb24vcXVlc3Rpb24vcXVlc3Rpb24uaHRtbCcsXG4gICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlKSB7XG4gICAgICAgICAgICBRdWVzdGlvbkZhY3RvcnkuZ2V0QWxsQnlMZWN0dXJlSWQoMSkudGhlbihmdW5jdGlvbihxdWVzdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBzY29wZS5xdWVzdGlvbnMgPSBxdWVzdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKHEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHEuc3RhdHVzID09PSAnb3BlbidcbiAgICAgICAgICAgICAgICB9KS5tYXAoZnVuY3Rpb24ocSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcS5oYXNVcHZvdGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIGZ1bmN0aW9uIGZpbmRJbmRleChxdWVzdGlvbikge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2NvcGUucXVlc3Rpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzY29wZS5xdWVzdGlvbnNbaV0udGV4dCA9PT0gcXVlc3Rpb24udGV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2NvcGUubmV3UXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHF1ZXN0aW9uID0ge3RleHQ6IHNjb3BlLm5ld1F1ZXN0aW9uLCBzdWJtaXRUaW1lOiBEYXRlLm5vdygpLCB1cHZvdGVzOiAwfVxuICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgnYWRkaW5nUXVlc3Rpb24nLCBxdWVzdGlvbilcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUubmV3UXVlc3Rpb24gPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2NvcGUuZGVsZXRlID0gZnVuY3Rpb24ocXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgnZGVsZXRpbmdRdWVzdGlvbicsIHF1ZXN0aW9uKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzY29wZS5zdG9yZSA9IGZ1bmN0aW9uKHF1ZXN0aW9uLCBzdGF0dXMpIHtcbiAgICAgICAgICAgICAgICBxdWVzdGlvbi5zdGF0dXMgPSBzdGF0dXNcbiAgICAgICAgICAgICAgICBRdWVzdGlvbkZhY3Rvcnkuc3RvcmUocXVlc3Rpb24pLnRoZW4oZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUuZGVsZXRlKHF1ZXN0aW9uKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNjb3BlLnVwdm90ZSA9IGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgc29ja2V0LmVtaXQoJ3Vwdm90aW5nJywgcXVlc3Rpb24pXG4gICAgICAgICAgICAgICAgcXVlc3Rpb24uaGFzVXB2b3RlZCA9ICFxdWVzdGlvbi5oYXNVcHZvdGVkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzY29wZS5kb3dudm90ZSA9IGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgc29ja2V0LmVtaXQoJ2Rvd252b3RpbmcnLCBxdWVzdGlvbilcbiAgICAgICAgICAgICAgICBxdWVzdGlvbi5oYXNVcHZvdGVkID0gIXF1ZXN0aW9uLmhhc1Vwdm90ZWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNvY2tldC5vbignYWRkUXVlc3Rpb24nLCBmdW5jdGlvbihxdWVzdGlvbikge1xuICAgICAgICAgICAgICAgIHNjb3BlLnF1ZXN0aW9ucy51bnNoaWZ0KHF1ZXN0aW9uKVxuICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsQXN5bmMoKVxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgc29ja2V0Lm9uKCdkZWxldGVRdWVzdGlvbicsIGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZmluZEluZGV4KHF1ZXN0aW9uKVxuICAgICAgICAgICAgICAgIHNjb3BlLnF1ZXN0aW9ucy5zcGxpY2UoaW5kZXgsIDEpXG4gICAgICAgICAgICAgICAgc2NvcGUuJGV2YWxBc3luYygpXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBzb2NrZXQub24oJ3JlY2VpdmVkVXB2b3RlJywgZnVuY3Rpb24ocXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kSW5kZXgocXVlc3Rpb24pXG4gICAgICAgICAgICAgICAgdmFyIHEgPSBzY29wZS5xdWVzdGlvbnNbaW5kZXhdXG4gICAgICAgICAgICAgICAgcS51cHZvdGVzID8gcS51cHZvdGVzKysgOiBxLnVwdm90ZXMgPSAxO1xuICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsQXN5bmMoKVxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgc29ja2V0Lm9uKCdyZWNlaXZlZERvd252b3RlJywgZnVuY3Rpb24ocXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kSW5kZXgocXVlc3Rpb24pXG4gICAgICAgICAgICAgICAgdmFyIHEgPSBzY29wZS5xdWVzdGlvbnNbaW5kZXhdXG4gICAgICAgICAgICAgICAgcS51cHZvdGVzLS07XG4gICAgICAgICAgICAgICAgc2NvcGUuJGV2YWxBc3luYygpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgfVxufSk7XG4iLCJhcHAuZmFjdG9yeSgnUXVlc3Rpb25GYWN0b3J5JywgZnVuY3Rpb24gKCRodHRwKSB7XG5cblx0dmFyIG9iaiA9IHt9O1xuXG5cdG9iai5nZXRBbGxCeUxlY3R1cmVJZCA9IGZ1bmN0aW9uKGxlY3R1cmVJZCkge1xuXHRcdHJldHVybiAkaHR0cC5nZXQoJy9hcGkvcXVlc3Rpb24vbGVjdHVyZS8nICsgbGVjdHVyZUlkKS50aGVuKGZ1bmN0aW9uKHJlcykge1xuXHRcdFx0cmV0dXJuIHJlcy5kYXRhO1xuXHRcdH0pXG5cdH1cblxuXHRvYmouc3RvcmUgPSBmdW5jdGlvbihxdWVzdGlvbikge1xuXHRcdHJldHVybiAkaHR0cC5wb3N0KCcvYXBpL3F1ZXN0aW9uJywgcXVlc3Rpb24pLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG5cdFx0XHRyZXR1cm4gcmVzLmRhdGE7XG5cdFx0fSlcblx0fVxuXG5cdHJldHVybiBvYmo7XG5cbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
