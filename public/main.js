'use strict';

window.app = angular.module('MyApp', ['ui.router', 'ui.bootstrap', 'ngAnimate', 'ngKookies']);

app.config(function ($urlRouterProvider, $locationProvider, $kookiesProvider) {
  // This turns off hashbang urls (/#about) and changes it to something normal (/about)
  $locationProvider.html5Mode(true);
  // If we go to a URL that ui-router doesn't have registered, go to the "/" url.
  $urlRouterProvider.otherwise('/');
  // Trigger page refresh when accessing an OAuth route
  $urlRouterProvider.when('/auth/:provider', function () {
    window.location.reload();
  });

  $kookiesProvider.config.json = true;
});

app.config(function ($stateProvider) {
  $stateProvider.state('student', {
    url: '/student',
    templateUrl: 'js/views/student/student.html'
  });
});

app.config(function ($stateProvider) {
  $stateProvider.state('admin', {
    url: '/admin',
    templateUrl: 'js/views/instructor/instructor.html'
  });
});

app.controller('LoginCtrl', function ($scope, $state) {

  console.log("reached login ctrl");
  $scope.loginStatus = function () {
    console.log("reached login status");
    var temp = $scope.login;
    console.log("temp: ", temp);

    if (temp === 'admin') {
      $state.go('admin');
    } else if (temp === 'student') {
      $state.go('student');
    }
  };
});

var socket = io(window.location.origin);

socket.on('connect', function () {});
app.controller('CreatePoll', function ($scope, $uibModal) {

  $scope.showModal = function () {

    $scope.opts = {
      backdrop: true,
      backdropClick: true,
      transclude: true,
      dialogFade: false,
      keyboard: true,
      templateUrl: 'js/common/createPollModal/createPollModal.html',
      controller: ModalInstanceCtrl,
      resolve: {} // empty storage
    };

    $scope.opts.resolve.item = function () {
      return angular.copy({ polls: $scope.polls }); // pass name to Dialog
    };

    var modalInstance = $uibModal.open($scope.opts);

    modalInstance.result.then(function () {
      //on ok button press
    }, function () {
      //on cancel button press
      console.log("Modal Closed");
    });
  };
});

var ModalInstanceCtrl = function ModalInstanceCtrl($scope, $uibModalInstance, $uibModal, item, PollFactory) {

  $scope.item = item;

  $scope.customOptions = function (option) {
    $scope.customShow = option === 'custom';
  };

  $scope.submitPoll = function () {
    var poll = {};
    poll.question = $scope.newPoll;
    poll.lectureId = 1;
    if ($scope.option == 'custom') poll.options = [$scope.a, $scope.b, $scope.c, $scope.d];

    PollFactory.createPoll(poll).then(function () {
      return PollFactory.getAllByLectureId(1);
    }).then(function (polls) {
      $scope.polls = polls;
    }).then(function () {
      $uibModalInstance.close();
    });
  };

  $scope.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };
};

app.directive('feedback', function ($state, FeedbackFactory) {
  return {
    restrict: 'E',
    scope: {},
    templateUrl: 'js/common/feedback/feedback.html',
    link: function link(scope) {
      scope.addMessage = false;
      scope.rejectMessage = false;

      scope.countFeedback = function (category) {
        if (category === 'Great' && !scope.greatCount || category === 'Confused' && !scope.confusedCount || category === 'Example' && !scope.exampleCount || category === 'Cannot See' && !scope.seeCount || category === 'Cannot Hear' && !scope.hearCount || category === 'Request Break' && !scope.breakCount) {
          return FeedbackFactory.addFeedback(category).then(function () {
            return FeedbackFactory.countFeedback(category);
          }).then(function (result) {
            socket.emit('submittedFeedback', category);

            console.log('IT IS HERE', result);
            if (category === 'Great') {
              scope.greatCount = result;
            }
            if (category === 'Confused') {
              scope.confusedCount = result;
            }
            if (category === 'Example') {
              scope.exampleCount = result;
            }
            if (category === 'Cannot See') {
              scope.seeCount = result;
            }
            if (category === 'Cannot Hear') {
              scope.hearCount = result;
            }
            if (category === 'Request Break') {
              scope.breakCount = result;
            }
          }).then(function () {
            scope.addMessage = true;
            setTimeout(function () {
              scope.addMessage = false;
              scope.$digest();
            }, 1500);
          }).then(function () {
            setTimeout(function () {
              scope.greatCount = null;
              scope.confusedCount = null;
              scope.exampleCount = null;
              scope.seeCount = null;
              scope.hearCount = null;
              scope.breakCount = null;
              scope.$digest();
            }, 30 * 1000);
          });
        } else {
          scope.rejectMessage = true;
          setTimeout(function () {
            scope.rejectMessage = false;
            scope.$digest();
          }, 1500);
        }
      };

      socket.on('updateFeedback', function (category) {
        console.log('received -->', category);

        return FeedbackFactory.countFeedback(category).then(function (result) {
          if (category === 'Great') {
            scope.greatCount = result;
          }
          if (category === 'Confused') {
            scope.confusedCount = result;
          }
          if (category === 'Example') {
            scope.exampleCount = result;
          }
          if (category === 'Cannot See') {
            scope.seeCount = result;
          }
          if (category === 'Cannot Hear') {
            scope.hearCount = result;
          }
          if (category === 'Request Break') {
            scope.breakCount = result;
          }
        }).then(function () {
          setTimeout(function () {
            scope.greatCount = null;
            scope.confusedCount = null;
            scope.exampleCount = null;
            scope.seeCount = null;
            scope.hearCount = null;
            scope.breakCount = null;
            scope.$digest();
          }, 30 * 1000);
        });
        // scope.$digest()
      });
    }
  };
});

app.factory('FeedbackFactory', function ($http) {
  var FeedbackFactory = {};

  FeedbackFactory.addFeedback = function (category) {
    return $http.post('/api/feedback/', { category: category }).then(function (result) {
      console.log('gotHERE', result);
    });
  };

  FeedbackFactory.countFeedback = function (category) {
    return $http.get('/api/feedback/count/' + category).then(function (result) {
      return result.data;
    });
  };

  return FeedbackFactory;
});
app.directive('poll', function ($state, PollFactory) {
  return {
    restrict: 'E',
    scope: {
      useCtrl: "@"
    },
    templateUrl: 'js/common/poll/poll.html',
    link: function link(scope) {

      scope.delete = PollFactory.deletePoll;

      PollFactory.getAllByLectureId(1).then(function (currentPolls) {
        scope.polls = currentPolls;
      });
    }
  };
});

app.factory('PollFactory', function ($http) {
  function dotData(dot) {
    return dot.data;
  }
  var cachedPolls = [];
  return {
    getAllByLectureId: function getAllByLectureId(id) {
      return $http.get('/api/poll/lecture/' + id).then(dotData).then(function (polls) {
        angular.copy(polls, cachedPolls);
        return cachedPolls;
      });
    },
    getOneByPollId: function getOneByPollId(id) {
      return $http.get('/api/poll/' + id).then(dotData);
    },
    createPoll: function createPoll(pollObj) {
      return $http.post('/api/poll/', pollObj).then(dotData);
    },
    updatePoll: function updatePoll(pollObj, id) {
      return $http.put('/api/poll/' + id, pollObj).then(dotData);
    },
    deletePoll: function deletePoll(id) {
      return $http.delete('/api/poll/' + id).then(dotData).then(function (removedPoll) {
        cachedPolls.splice(cachedPolls.map(function (item) {
          return item.id;
        }).indexOf(id), 1);
        return cachedPolls;
      });
    }
  };
});

app.directive('question', function ($state, QuestionFactory) {

  return {
    restrict: 'E',
    scope: {},
    templateUrl: 'js/common/question/question.html',
    link: function link(scope) {
      QuestionFactory.getAllByLectureId(1).then(function (questions) {
        scope.questions = questions.filter(function (q) {
          return q.status === 'open';
        }).map(function (q) {
          return q.hasUpvoted = false;
        });
      });

      function findIndex(question) {
        for (var i = 0; i < scope.questions.length; i++) {
          if (scope.questions[i].text === question.text) {
            return i;
          }
        }
        return -1;
      }

      scope.submit = function () {
        if (scope.newQuestion) {
          var question = { text: scope.newQuestion, submitTime: Date.now(), upvotes: 0 };
          socket.emit('addingQuestion', question);
          scope.newQuestion = null;
        }
      };

      scope.delete = function (question) {
        socket.emit('deletingQuestion', question);
      };

      scope.store = function (question, status) {
        question.status = status;
        QuestionFactory.store(question).then(function () {
          scope.delete(question);
        });
      };

      scope.upvote = function (question) {
        socket.emit('upvoting', question);
        question.hasUpvoted = !question.hasUpvoted;
      };

      scope.downvote = function (question) {
        socket.emit('downvoting', question);
        question.hasUpvoted = !question.hasUpvoted;
      };

      socket.on('addQuestion', function (question) {
        scope.questions.unshift(question);
        scope.$evalAsync();
      });

      socket.on('deleteQuestion', function (question) {
        var index = findIndex(question);
        scope.questions.splice(index, 1);
        scope.$evalAsync();
      });

      socket.on('receivedUpvote', function (question) {
        var index = findIndex(question);
        var q = scope.questions[index];
        q.upvotes ? q.upvotes++ : q.upvotes = 1;
        scope.$evalAsync();
      });

      socket.on('receivedDownvote', function (question) {
        var index = findIndex(question);
        var q = scope.questions[index];
        q.upvotes--;
        scope.$evalAsync();
      });
    }
  };
});

app.factory('QuestionFactory', function ($http) {

  var obj = {};

  obj.getAllByLectureId = function (lectureId) {
    return $http.get('/api/question/lecture/' + lectureId).then(function (res) {
      return res.data;
    });
  };

  obj.store = function (question) {
    return $http.post('/api/question', question).then(function (res) {
      return res.data;
    });
  };

  return obj;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsInNvY2tldC5qcyIsImNvbW1vbi9jcmVhdGVQb2xsTW9kYWwvY3JlYXRlUG9sbC5jb250cm9sbGVyLmpzIiwiY29tbW9uL2ZlZWRiYWNrL2ZlZWRiYWNrLmRpcmVjdGl2ZS5qcyIsImNvbW1vbi9mZWVkYmFjay9mZWVkYmFjay5mYWN0b3J5LmpzIiwiY29tbW9uL3BvbGwvcG9sbC5kaXJlY3RpdmUuanMiLCJjb21tb24vcG9sbC9wb2xsLmZhY3RvcnkuanMiLCJjb21tb24vcXVlc3Rpb24vcXVlc3Rpb24uZGlyZWN0aXZlLmpzIiwiY29tbW9uL3F1ZXN0aW9uL3F1ZXN0aW9uLmZhY3RvcnkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsT0FBQSxHQUFBLEdBQUEsUUFBQSxNQUFBLENBQUEsT0FBQSxFQUFBLENBQUEsV0FBQSxFQUFBLGNBQUEsRUFBQSxXQUFBLEVBQUEsV0FBQSxDQUFBLENBQUE7O0FBRUEsSUFBQSxNQUFBLENBQUEsVUFBQSxrQkFBQSxFQUFBLGlCQUFBLEVBQUEsZ0JBQUEsRUFBQTs7QUFFQSxvQkFBQSxTQUFBLENBQUEsSUFBQTs7QUFFQSxxQkFBQSxTQUFBLENBQUEsR0FBQTs7QUFFQSxxQkFBQSxJQUFBLENBQUEsaUJBQUEsRUFBQSxZQUFBO0FBQ0EsV0FBQSxRQUFBLENBQUEsTUFBQTtBQUNBLEdBRkE7O0FBSUEsbUJBQUEsTUFBQSxDQUFBLElBQUEsR0FBQSxJQUFBO0FBRUEsQ0FaQTs7QUFjQSxJQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGlCQUFBLEtBQUEsQ0FBQSxTQUFBLEVBQUE7QUFDQSxTQUFBLFVBREE7QUFFQSxpQkFBQTtBQUZBLEdBQUE7QUFJQSxDQUxBOztBQU9BLElBQUEsTUFBQSxDQUFBLFVBQUEsY0FBQSxFQUFBO0FBQ0EsaUJBQUEsS0FBQSxDQUFBLE9BQUEsRUFBQTtBQUNBLFNBQUEsUUFEQTtBQUVBLGlCQUFBO0FBRkEsR0FBQTtBQUlBLENBTEE7O0FB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YUFBQSxHQUFBLEtBQUE7O0FBRUEsWUFBQSxhQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxZQUFBLGFBQUEsT0FBQSxJQUFBLENBQUEsTUFBQSxVQUFBLElBQUEsYUFBQSxVQUFBLElBQUEsQ0FBQSxNQUFBLGFBQUEsSUFBQSxhQUFBLFNBQUEsSUFBQSxDQUFBLE1BQUEsWUFBQSxJQUFBLGFBQUEsWUFBQSxJQUFBLENBQUEsTUFBQSxRQUFBLElBQUEsYUFBQSxhQUFBLElBQUEsQ0FBQSxNQUFBLFNBQUEsSUFBQSxhQUFBLGVBQUEsSUFBQSxDQUFBLE1BQUEsVUFBQSxFQUFBO0FBQ0EsaUJBQUEsZ0JBQUEsV0FBQSxDQUFBLFFBQUEsRUFDQSxJQURBLENBQ0EsWUFBQTtBQUNBLG1CQUFBLGdCQUFBLGFBQUEsQ0FBQSxRQUFBLENBQUE7QUFDQSxXQUhBLEVBSUEsSUFKQSxDQUlBLFVBQUEsTUFBQSxFQUFBO0FBQ0EsbUJBQUEsSUFBQSxDQUFBLG1CQUFBLEVBQUEsUUFBQTs7QUFFQSxvQkFBQSxHQUFBLENBQUEsWUFBQSxFQUFBLE1BQUE7QUFDQSxnQkFBQSxhQUFBLE9BQUEsRUFBQTtBQUNBLG9CQUFBLFVBQUEsR0FBQSxNQUFBO0FBQ0E7QUFDQSxnQkFBQSxhQUFBLFVBQUEsRUFBQTtBQUNBLG9CQUFBLGFBQUEsR0FBQSxNQUFBO0FBQ0E7QUFDQSxnQkFBQSxhQUFBLFNBQUEsRUFBQTtBQUNBLG9CQUFBLFlBQUEsR0FBQSxNQUFBO0FBQ0E7QUFDQSxnQkFBQSxhQUFBLFlBQUEsRUFBQTtBQUNBLG9CQUFBLFFBQUEsR0FBQSxNQUFBO0FBQ0E7QUFDQSxnQkFBQSxhQUFBLGFBQUEsRUFBQTtBQUNBLG9CQUFBLFNBQUEsR0FBQSxNQUFBO0FBQ0E7QUFDQSxnQkFBQSxhQUFBLGVBQUEsRUFBQTtBQUNBLG9CQUFBLFVBQUEsR0FBQSxNQUFBO0FBQ0E7QUFDQSxXQTFCQSxFQTJCQSxJQTNCQSxDQTJCQSxZQUFBO0FBQ0Esa0JBQUEsVUFBQSxHQUFBLElBQUE7QUFDQSx1QkFBQSxZQUFBO0FBQ0Esb0JBQUEsVUFBQSxHQUFBLEtBQUE7QUFDQSxvQkFBQSxPQUFBO0FBQ0EsYUFIQSxFQUdBLElBSEE7QUFJQSxXQWpDQSxFQWtDQSxJQWxDQSxDQWtDQSxZQUFBO0FBQ0EsdUJBQUEsWUFBQTtBQUNBLG9CQUFBLFVBQUEsR0FBQSxJQUFBO0FBQ0Esb0JBQUEsYUFBQSxHQUFBLElBQUE7QUFDQSxvQkFBQSxZQUFBLEdBQUEsSUFBQTtBQUNBLG9CQUFBLFFBQUEsR0FBQSxJQUFBO0FBQ0Esb0JBQUEsU0FBQSxHQUFBLElBQUE7QUFDQSxvQkFBQSxVQUFBLEdBQUEsSUFBQTtBQUNBLG9CQUFBLE9BQUE7QUFDQSxhQVJBLEVBUUEsS0FBQSxJQVJBO0FBU0EsV0E1Q0EsQ0FBQTtBQTZDQSxTQTlDQSxNQWdEQTtBQUNBLGdCQUFBLGFBQUEsR0FBQSxJQUFBO0FBQ0EscUJBQUEsWUFBQTtBQUNBLGtCQUFBLGFBQUEsR0FBQSxLQUFBO0FBQ0Esa0JBQUEsT0FBQTtBQUNBLFdBSEEsRUFHQSxJQUhBO0FBSUE7QUFDQSxPQXhEQTs7QUEwREEsYUFBQSxFQUFBLENBQUEsZ0JBQUEsRUFBQSxVQUFBLFFBQUEsRUFBQTtBQUNBLGdCQUFBLEdBQUEsQ0FBQSxjQUFBLEVBQUEsUUFBQTs7QUFFQSxlQUFBLGdCQUFBLGFBQUEsQ0FBQSxRQUFBLEVBQ0EsSUFEQSxDQUNBLFVBQUEsTUFBQSxFQUFBO0FBQ0EsY0FBQSxhQUFBLE9BQUEsRUFBQTtBQUNBLGtCQUFBLFVBQUEsR0FBQSxNQUFBO0FBQ0E7QUFDQSxjQUFBLGFBQUEsVUFBQSxFQUFBO0FBQ0Esa0JBQUEsYUFBQSxHQUFBLE1BQUE7QUFDQTtBQUNBLGNBQUEsYUFBQSxTQUFBLEVBQUE7QUFDQSxrQkFBQSxZQUFBLEdBQUEsTUFBQTtBQUNBO0FBQ0EsY0FBQSxhQUFBLFlBQUEsRUFBQTtBQUNBLGtCQUFBLFFBQUEsR0FBQSxNQUFBO0FBQ0E7QUFDQSxjQUFBLGFBQUEsYUFBQSxFQUFBO0FBQ0Esa0JBQUEsU0FBQSxHQUFBLE1BQUE7QUFDQTtBQUNBLGNBQUEsYUFBQSxlQUFBLEVBQUE7QUFDQSxrQkFBQSxVQUFBLEdBQUEsTUFBQTtBQUNBO0FBQ0EsU0FwQkEsRUFxQkEsSUFyQkEsQ0FxQkEsWUFBQTtBQUNBLHFCQUFBLFlBQUE7QUFDQSxrQkFBQSxVQUFBLEdBQUEsSUFBQTtBQUNBLGtCQUFBLGFBQUEsR0FBQSxJQUFBO0FBQ0Esa0JBQUEsWUFBQSxHQUFBLElBQUE7QUFDQSxrQkFBQSxRQUFBLEdBQUEsSUFBQTtBQUNBLGtCQUFBLFNBQUEsR0FBQSxJQUFBO0FBQ0Esa0JBQUEsVUFBQSxHQUFBLElBQUE7QUFDQSxrQkFBQSxPQUFBO0FBQ0EsV0FSQSxFQVFBLEtBQUEsSUFSQTtBQVNBLFNBL0JBLENBQUE7O0FBaUNBLE9BcENBO0FBc0NBO0FBMUdBLEdBQUE7QUE0R0EsQ0E3R0E7O0FDQUEsSUFBQSxPQUFBLENBQUEsaUJBQUEsRUFBQSxVQUFBLEtBQUEsRUFBQTtBQUNBLE1BQUEsa0JBQUEsRUFBQTs7QUFFQSxrQkFBQSxXQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxXQUFBLE1BQUEsSUFBQSxDQUFBLGdCQUFBLEVBQUEsRUFBQSxVQUFBLFFBQUEsRUFBQSxFQUNBLElBREEsQ0FDQSxVQUFBLE1BQUEsRUFBQTtBQUNBLGNBQUEsR0FBQSxDQUFBLFNBQUEsRUFBQSxNQUFBO0FBQ0EsS0FIQSxDQUFBO0FBSUEsR0FMQTs7QUFPQSxrQkFBQSxhQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxXQUFBLE1BQUEsR0FBQSxDQUFBLHlCQUFBLFFBQUEsRUFDQSxJQURBLENBQ0EsVUFBQSxNQUFBLEVBQUE7QUFDQSxhQUFBLE9BQUEsSUFBQTtBQUNBLEtBSEEsQ0FBQTtBQUlBLEdBTEE7O0FBT0EsU0FBQSxlQUFBO0FBQ0EsQ0FsQkE7QUNBQSxJQUFBLFNBQUEsQ0FBQSxNQUFBLEVBQUEsVUFBQSxNQUFBLEVBQUEsV0FBQSxFQUFBO0FBQ0EsU0FBQTtBQUNBLGNBQUEsR0FEQTtBQUVBLFdBQUE7QUFDQSxlQUFBO0FBREEsS0FGQTtBQUtBLGlCQUFBLDBCQUxBO0FBTUEsVUFBQSxjQUFBLEtBQUEsRUFBQTs7QUFFQSxZQUFBLE1BQUEsR0FBQSxZQUFBLFVBQUE7O0FBRUEsa0JBQUEsaUJBQUEsQ0FBQSxDQUFBLEVBQ0EsSUFEQSxDQUNBLFVBQUEsWUFBQSxFQUFBO0FBQ0EsY0FBQSxLQUFBLEdBQUEsWUFBQTtBQUNBLE9BSEE7QUFNQTtBQWhCQSxHQUFBO0FBa0JBLENBbkJBOztBQ0FBLElBQUEsT0FBQSxDQUFBLGFBQUEsRUFBQSxVQUFBLEtBQUEsRUFBQTtBQUNBLFdBQUEsT0FBQSxDQUFBLEdBQUEsRUFBQTtBQUNBLFdBQUEsSUFBQSxJQUFBO0FBQ0E7QUFDQSxNQUFBLGNBQUEsRUFBQTtBQUNBLFNBQUE7QUFDQSx1QkFBQSwyQkFBQSxFQUFBLEVBQUE7QUFDQSxhQUFBLE1BQUEsR0FBQSxDQUFBLHVCQUFBLEVBQUEsRUFDQSxJQURBLENBQ0EsT0FEQSxFQUVBLElBRkEsQ0FFQSxVQUFBLEtBQUEsRUFBQTtBQUNBLGdCQUFBLElBQUEsQ0FBQSxLQUFBLEVBQUEsV0FBQTtBQUNBLGVBQUEsV0FBQTtBQUNBLE9BTEEsQ0FBQTtBQU1BLEtBUkE7QUFTQSxvQkFBQSx3QkFBQSxFQUFBLEVBQUE7QUFDQSxhQUFBLE1BQUEsR0FBQSxDQUFBLGVBQUEsRUFBQSxFQUNBLElBREEsQ0FDQSxPQURBLENBQUE7QUFFQSxLQVpBO0FBYUEsZ0JBQUEsb0JBQUEsT0FBQSxFQUFBO0FBQ0EsYUFBQSxNQUFBLElBQUEsQ0FBQSxZQUFBLEVBQUEsT0FBQSxFQUNBLElBREEsQ0FDQSxPQURBLENBQUE7QUFFQSxLQWhCQTtBQWlCQSxnQkFBQSxvQkFBQSxPQUFBLEVBQUEsRUFBQSxFQUFBO0FBQ0EsYUFBQSxNQUFBLEdBQUEsQ0FBQSxlQUFBLEVBQUEsRUFBQSxPQUFBLEVBQ0EsSUFEQSxDQUNBLE9BREEsQ0FBQTtBQUVBLEtBcEJBO0FBcUJBLGdCQUFBLG9CQUFBLEVBQUEsRUFBQTtBQUNBLGFBQUEsTUFBQSxNQUFBLENBQUEsZUFBQSxFQUFBLEVBQ0EsSUFEQSxDQUNBLE9BREEsRUFFQSxJQUZBLENBRUEsVUFBQSxXQUFBLEVBQUE7QUFDQSxvQkFBQSxNQUFBLENBQUEsWUFBQSxHQUFBLENBQUEsVUFBQSxJQUFBLEVBQUE7QUFBQSxpQkFBQSxLQUFBLEVBQUE7QUFBQSxTQUFBLEVBQUEsT0FBQSxDQUFBLEVBQUEsQ0FBQSxFQUFBLENBQUE7QUFDQSxlQUFBLFdBQUE7QUFDQSxPQUxBLENBQUE7QUFNQTtBQTVCQSxHQUFBO0FBOEJBLENBbkNBOztBQ0FBLElBQUEsU0FBQSxDQUFBLFVBQUEsRUFBQSxVQUFBLE1BQUEsRUFBQSxlQUFBLEVBQUE7O0FBRUEsU0FBQTtBQUNBLGNBQUEsR0FEQTtBQUVBLFdBQUEsRUFGQTtBQUtBLGlCQUFBLGtDQUxBO0FBTUEsVUFBQSxjQUFBLEtBQUEsRUFBQTtBQUNBLHNCQUFBLGlCQUFBLENBQUEsQ0FBQSxFQUFBLElBQUEsQ0FBQSxVQUFBLFNBQUEsRUFBQTtBQUNBLGNBQUEsU0FBQSxHQUFBLFVBQUEsTUFBQSxDQUFBLFVBQUEsQ0FBQSxFQUFBO0FBQ0EsaUJBQUEsRUFBQSxNQUFBLEtBQUEsTUFBQTtBQUNBLFNBRkEsRUFFQSxHQUZBLENBRUEsVUFBQSxDQUFBLEVBQUE7QUFDQSxpQkFBQSxFQUFBLFVBQUEsR0FBQSxLQUFBO0FBQ0EsU0FKQSxDQUFBO0FBS0EsT0FOQTs7QUFRQSxlQUFBLFNBQUEsQ0FBQSxRQUFBLEVBQUE7QUFDQSxhQUFBLElBQUEsSUFBQSxDQUFBLEVBQUEsSUFBQSxNQUFBLFNBQUEsQ0FBQSxNQUFBLEVBQUEsR0FBQSxFQUFBO0FBQ0EsY0FBQSxNQUFBLFNBQUEsQ0FBQSxDQUFBLEVBQUEsSUFBQSxLQUFBLFNBQUEsSUFBQSxFQUFBO0FBQ0EsbUJBQUEsQ0FBQTtBQUNBO0FBQ0E7QUFDQSxlQUFBLENBQUEsQ0FBQTtBQUNBOztBQUVBLFlBQUEsTUFBQSxHQUFBLFlBQUE7QUFDQSxZQUFBLE1BQUEsV0FBQSxFQUFBO0FBQ0EsY0FBQSxXQUFBLEVBQUEsTUFBQSxNQUFBLFdBQUEsRUFBQSxZQUFBLEtBQUEsR0FBQSxFQUFBLEVBQUEsU0FBQSxDQUFBLEVBQUE7QUFDQSxpQkFBQSxJQUFBLENBQUEsZ0JBQUEsRUFBQSxRQUFBO0FBQ0EsZ0JBQUEsV0FBQSxHQUFBLElBQUE7QUFDQTtBQUNBLE9BTkE7O0FBUUEsWUFBQSxNQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxlQUFBLElBQUEsQ0FBQSxrQkFBQSxFQUFBLFFBQUE7QUFDQSxPQUZBOztBQUlBLFlBQUEsS0FBQSxHQUFBLFVBQUEsUUFBQSxFQUFBLE1BQUEsRUFBQTtBQUNBLGlCQUFBLE1BQUEsR0FBQSxNQUFBO0FBQ0Esd0JBQUEsS0FBQSxDQUFBLFFBQUEsRUFBQSxJQUFBLENBQUEsWUFBQTtBQUNBLGdCQUFBLE1BQUEsQ0FBQSxRQUFBO0FBQ0EsU0FGQTtBQUdBLE9BTEE7O0FBT0EsWUFBQSxNQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxlQUFBLElBQUEsQ0FBQSxVQUFBLEVBQUEsUUFBQTtBQUNBLGlCQUFBLFVBQUEsR0FBQSxDQUFBLFNBQUEsVUFBQTtBQUNBLE9BSEE7O0FBS0EsWUFBQSxRQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxlQUFBLElBQUEsQ0FBQSxZQUFBLEVBQUEsUUFBQTtBQUNBLGlCQUFBLFVBQUEsR0FBQSxDQUFBLFNBQUEsVUFBQTtBQUNBLE9BSEE7O0FBS0EsYUFBQSxFQUFBLENBQUEsYUFBQSxFQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsY0FBQSxTQUFBLENBQUEsT0FBQSxDQUFBLFFBQUE7QUFDQSxjQUFBLFVBQUE7QUFDQSxPQUhBOztBQUtBLGFBQUEsRUFBQSxDQUFBLGdCQUFBLEVBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxZQUFBLFFBQUEsVUFBQSxRQUFBLENBQUE7QUFDQSxjQUFBLFNBQUEsQ0FBQSxNQUFBLENBQUEsS0FBQSxFQUFBLENBQUE7QUFDQSxjQUFBLFVBQUE7QUFDQSxPQUpBOztBQU1BLGFBQUEsRUFBQSxDQUFBLGdCQUFBLEVBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxZQUFBLFFBQUEsVUFBQSxRQUFBLENBQUE7QUFDQSxZQUFBLElBQUEsTUFBQSxTQUFBLENBQUEsS0FBQSxDQUFBO0FBQ0EsVUFBQSxPQUFBLEdBQUEsRUFBQSxPQUFBLEVBQUEsR0FBQSxFQUFBLE9BQUEsR0FBQSxDQUFBO0FBQ0EsY0FBQSxVQUFBO0FBQ0EsT0FMQTs7QUFPQSxhQUFBLEVBQUEsQ0FBQSxrQkFBQSxFQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsWUFBQSxRQUFBLFVBQUEsUUFBQSxDQUFBO0FBQ0EsWUFBQSxJQUFBLE1BQUEsU0FBQSxDQUFBLEtBQUEsQ0FBQTtBQUNBLFVBQUEsT0FBQTtBQUNBLGNBQUEsVUFBQTtBQUNBLE9BTEE7QUFNQTtBQTdFQSxHQUFBO0FBK0VBLENBakZBOztBQ0FBLElBQUEsT0FBQSxDQUFBLGlCQUFBLEVBQUEsVUFBQSxLQUFBLEVBQUE7O0FBRUEsTUFBQSxNQUFBLEVBQUE7O0FBRUEsTUFBQSxpQkFBQSxHQUFBLFVBQUEsU0FBQSxFQUFBO0FBQ0EsV0FBQSxNQUFBLEdBQUEsQ0FBQSwyQkFBQSxTQUFBLEVBQUEsSUFBQSxDQUFBLFVBQUEsR0FBQSxFQUFBO0FBQ0EsYUFBQSxJQUFBLElBQUE7QUFDQSxLQUZBLENBQUE7QUFHQSxHQUpBOztBQU1BLE1BQUEsS0FBQSxHQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsV0FBQSxNQUFBLElBQUEsQ0FBQSxlQUFBLEVBQUEsUUFBQSxFQUFBLElBQUEsQ0FBQSxVQUFBLEdBQUEsRUFBQTtBQUNBLGFBQUEsSUFBQSxJQUFBO0FBQ0EsS0FGQSxDQUFBO0FBR0EsR0FKQTs7QUFNQSxTQUFBLEdBQUE7QUFFQSxDQWxCQSIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG53aW5kb3cuYXBwID0gYW5ndWxhci5tb2R1bGUoJ015QXBwJywgWyd1aS5yb3V0ZXInLCAndWkuYm9vdHN0cmFwJywgJ25nQW5pbWF0ZScsICduZ0tvb2tpZXMnXSk7XG5cbmFwcC5jb25maWcoZnVuY3Rpb24gKCR1cmxSb3V0ZXJQcm92aWRlciwgJGxvY2F0aW9uUHJvdmlkZXIsICRrb29raWVzUHJvdmlkZXIpIHtcbiAgICAvLyBUaGlzIHR1cm5zIG9mZiBoYXNoYmFuZyB1cmxzICgvI2Fib3V0KSBhbmQgY2hhbmdlcyBpdCB0byBzb21ldGhpbmcgbm9ybWFsICgvYWJvdXQpXG4gICAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpO1xuICAgIC8vIElmIHdlIGdvIHRvIGEgVVJMIHRoYXQgdWktcm91dGVyIGRvZXNuJ3QgaGF2ZSByZWdpc3RlcmVkLCBnbyB0byB0aGUgXCIvXCIgdXJsLlxuICAgICR1cmxSb3V0ZXJQcm92aWRlci5vdGhlcndpc2UoJy8nKTtcbiAgICAvLyBUcmlnZ2VyIHBhZ2UgcmVmcmVzaCB3aGVuIGFjY2Vzc2luZyBhbiBPQXV0aCByb3V0ZVxuICAgICR1cmxSb3V0ZXJQcm92aWRlci53aGVuKCcvYXV0aC86cHJvdmlkZXInLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcbiAgICB9KTtcblxuICAgICRrb29raWVzUHJvdmlkZXIuY29uZmlnLmpzb24gPSB0cnVlO1xuXG59KTtcblxuYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIpIHtcbiAgICAkc3RhdGVQcm92aWRlci5zdGF0ZSgnc3R1ZGVudCcsIHtcbiAgICAgICAgdXJsOiAnL3N0dWRlbnQnLFxuICAgICAgICB0ZW1wbGF0ZVVybDogJ2pzL3ZpZXdzL3N0dWRlbnQvc3R1ZGVudC5odG1sJyxcbiAgICB9KTtcbn0pO1xuXG5hcHAuY29uZmlnKGZ1bmN0aW9uICgkc3RhdGVQcm92aWRlcikge1xuICAgICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdhZG1pbicsIHtcbiAgICAgICAgdXJsOiAnL2FkbWluJyxcbiAgICAgICAgdGVtcGxhdGVVcmw6ICdqcy92aWV3cy9pbnN0cnVjdG9yL2luc3RydWN0b3IuaHRtbCcsXG4gICAgfSk7XG59KTtcblxuYXBwLmNvbnRyb2xsZXIoJ0xvZ2luQ3RybCcsIGZ1bmN0aW9uICgkc2NvcGUsICRzdGF0ZSkge1xuXG5cdGNvbnNvbGUubG9nKFwicmVhY2hlZCBsb2dpbiBjdHJsXCIpO1xuXHQkc2NvcGUubG9naW5TdGF0dXMgPSBmdW5jdGlvbigpe1xuXHRcdGNvbnNvbGUubG9nKFwicmVhY2hlZCBsb2dpbiBzdGF0dXNcIik7XG5cdFx0dmFyIHRlbXAgPSAkc2NvcGUubG9naW47XG5cdFx0Y29uc29sZS5sb2coXCJ0ZW1wOiBcIix0ZW1wKTtcblxuXHRcdGlmICh0ZW1wPT09J2FkbWluJyl7XG5cdFx0XHQkc3RhdGUuZ28oJ2FkbWluJyk7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKHRlbXA9PT0nc3R1ZGVudCcpe1xuXHRcdFx0JHN0YXRlLmdvKCdzdHVkZW50Jyk7XG5cdFx0fVxuXHR9XG5cbn0pO1xuIiwidmFyIHNvY2tldCA9IGlvKHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4pO1xuXG5zb2NrZXQub24oJ2Nvbm5lY3QnLCBmdW5jdGlvbigpIHtcbiAgICBcbn0pIiwiYXBwLmNvbnRyb2xsZXIoJ0NyZWF0ZVBvbGwnLCBmdW5jdGlvbigkc2NvcGUsICR1aWJNb2RhbCkge1xuXG4gICRzY29wZS5zaG93TW9kYWwgPSBmdW5jdGlvbigpIHtcblxuICAgICRzY29wZS5vcHRzID0ge1xuICAgIGJhY2tkcm9wOiB0cnVlLFxuICAgIGJhY2tkcm9wQ2xpY2s6IHRydWUsXG4gICAgdHJhbnNjbHVkZTogdHJ1ZSxcbiAgICBkaWFsb2dGYWRlOiBmYWxzZSxcbiAgICBrZXlib2FyZDogdHJ1ZSxcbiAgICB0ZW1wbGF0ZVVybCA6ICdqcy9jb21tb24vY3JlYXRlUG9sbE1vZGFsL2NyZWF0ZVBvbGxNb2RhbC5odG1sJyxcbiAgICBjb250cm9sbGVyIDogTW9kYWxJbnN0YW5jZUN0cmwsXG4gICAgcmVzb2x2ZToge30gLy8gZW1wdHkgc3RvcmFnZVxuICAgICAgfTtcblxuICAgICRzY29wZS5vcHRzLnJlc29sdmUuaXRlbSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gYW5ndWxhci5jb3B5KHtwb2xsczokc2NvcGUucG9sbHN9KTsgLy8gcGFzcyBuYW1lIHRvIERpYWxvZ1xuICAgIH1cblxuICAgICAgdmFyIG1vZGFsSW5zdGFuY2UgPSAkdWliTW9kYWwub3Blbigkc2NvcGUub3B0cyk7XG5cbiAgICAgIG1vZGFsSW5zdGFuY2UucmVzdWx0LnRoZW4oZnVuY3Rpb24oKXtcbiAgICAgICAgLy9vbiBvayBidXR0b24gcHJlc3NcbiAgICAgIH0sZnVuY3Rpb24oKXtcbiAgICAgICAgLy9vbiBjYW5jZWwgYnV0dG9uIHByZXNzXG4gICAgICAgIGNvbnNvbGUubG9nKFwiTW9kYWwgQ2xvc2VkXCIpO1xuICAgICAgfSlcbiAgfVxuXG59KVxuXG52YXIgTW9kYWxJbnN0YW5jZUN0cmwgPSBmdW5jdGlvbigkc2NvcGUsICR1aWJNb2RhbEluc3RhbmNlLCAkdWliTW9kYWwsIGl0ZW0sIFBvbGxGYWN0b3J5KSB7XG5cbiAgJHNjb3BlLml0ZW0gPSBpdGVtO1xuXG4gICRzY29wZS5jdXN0b21PcHRpb25zID0gZnVuY3Rpb24ob3B0aW9uKSB7XG4gICAgJHNjb3BlLmN1c3RvbVNob3cgPSAob3B0aW9uID09PSAnY3VzdG9tJylcbiAgfVxuXG4gICRzY29wZS5zdWJtaXRQb2xsID0gZnVuY3Rpb24gKCkge1xuICAgIHZhciBwb2xsID0ge31cbiAgICBwb2xsLnF1ZXN0aW9uID0gJHNjb3BlLm5ld1BvbGxcbiAgICBwb2xsLmxlY3R1cmVJZCA9IDFcbiAgICBpZiAoJHNjb3BlLm9wdGlvbj09J2N1c3RvbScpIHBvbGwub3B0aW9ucyA9IFskc2NvcGUuYSwgJHNjb3BlLmIsICRzY29wZS5jLCAkc2NvcGUuZF1cblxuICAgIFBvbGxGYWN0b3J5LmNyZWF0ZVBvbGwocG9sbClcbiAgICAudGhlbigoKSA9PiB7IHJldHVybiBQb2xsRmFjdG9yeS5nZXRBbGxCeUxlY3R1cmVJZCgxKSB9KVxuICAgIC50aGVuKChwb2xscykgPT4geyAkc2NvcGUucG9sbHMgPSBwb2xscyB9KVxuICAgIC50aGVuKCgpID0+IHsgJHVpYk1vZGFsSW5zdGFuY2UuY2xvc2UoKSB9KVxuICB9XG5cbiAgJHNjb3BlLmNhbmNlbCA9IGZ1bmN0aW9uICgpIHtcbiAgICAkdWliTW9kYWxJbnN0YW5jZS5kaXNtaXNzKCdjYW5jZWwnKTtcbiAgfVxufVxuIiwiYXBwLmRpcmVjdGl2ZSgnZmVlZGJhY2snLCAoJHN0YXRlLCBGZWVkYmFja0ZhY3RvcnkpID0+IHtcbiAgcmV0dXJuIHtcbiAgICByZXN0cmljdDogJ0UnLFxuICAgIHNjb3BlOiB7XG5cbiAgICB9LFxuICAgIHRlbXBsYXRlVXJsOiAnanMvY29tbW9uL2ZlZWRiYWNrL2ZlZWRiYWNrLmh0bWwnLFxuICAgIGxpbms6IChzY29wZSkgPT4ge1xuICAgICAgc2NvcGUuYWRkTWVzc2FnZSA9IGZhbHNlO1xuICAgICAgc2NvcGUucmVqZWN0TWVzc2FnZSA9IGZhbHNlO1xuXG4gICAgICBzY29wZS5jb3VudEZlZWRiYWNrID0gZnVuY3Rpb24gKGNhdGVnb3J5KSB7XG4gICAgICAgIGlmICgoY2F0ZWdvcnkgPT09ICdHcmVhdCcgJiYgIXNjb3BlLmdyZWF0Q291bnQpIHx8IChjYXRlZ29yeSA9PT0gJ0NvbmZ1c2VkJyAmJiAhc2NvcGUuY29uZnVzZWRDb3VudCkgfHwgKGNhdGVnb3J5ID09PSAnRXhhbXBsZScgJiYgIXNjb3BlLmV4YW1wbGVDb3VudCkgfHwgKGNhdGVnb3J5ID09PSAnQ2Fubm90IFNlZScgJiYgIXNjb3BlLnNlZUNvdW50KSB8fCAoY2F0ZWdvcnkgPT09ICdDYW5ub3QgSGVhcicgJiYgIXNjb3BlLmhlYXJDb3VudCkgfHwgKGNhdGVnb3J5ID09PSAnUmVxdWVzdCBCcmVhaycgJiYgIXNjb3BlLmJyZWFrQ291bnQpKSB7XG4gICAgICAgIHJldHVybiBGZWVkYmFja0ZhY3RvcnkuYWRkRmVlZGJhY2soY2F0ZWdvcnkpXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICByZXR1cm4gRmVlZGJhY2tGYWN0b3J5LmNvdW50RmVlZGJhY2soY2F0ZWdvcnkpXG4gICAgICAgIH0pIFxuICAgICAgICAudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgICAgICAgc29ja2V0LmVtaXQoJ3N1Ym1pdHRlZEZlZWRiYWNrJywgY2F0ZWdvcnkpXG4gICAgICAgICAgXG4gICAgICAgICAgY29uc29sZS5sb2coJ0lUIElTIEhFUkUnLCByZXN1bHQpXG4gICAgICAgICAgaWYgKGNhdGVnb3J5ID09PSAnR3JlYXQnKSB7XG4gICAgICAgICAgICBzY29wZS5ncmVhdENvdW50ID0gcmVzdWx0XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjYXRlZ29yeSA9PT0gJ0NvbmZ1c2VkJykge1xuICAgICAgICAgICAgc2NvcGUuY29uZnVzZWRDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdFeGFtcGxlJykge1xuICAgICAgICAgICAgc2NvcGUuZXhhbXBsZUNvdW50ID0gcmVzdWx0XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjYXRlZ29yeSA9PT0gJ0Nhbm5vdCBTZWUnKSB7XG4gICAgICAgICAgICBzY29wZS5zZWVDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdDYW5ub3QgSGVhcicpIHtcbiAgICAgICAgICAgIHNjb3BlLmhlYXJDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdSZXF1ZXN0IEJyZWFrJykge1xuICAgICAgICAgICAgc2NvcGUuYnJlYWtDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHNjb3BlLmFkZE1lc3NhZ2UgPSB0cnVlXG4gICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgICAgICAgc2NvcGUuYWRkTWVzc2FnZSA9IGZhbHNlO1xuICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpO1xuICAgICAgICAgIH0sIDE1MDApO1xuICAgICAgICB9KVxuICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHNjb3BlLmdyZWF0Q291bnQgPSBudWxsO1xuICAgICAgICAgICAgc2NvcGUuY29uZnVzZWRDb3VudCA9IG51bGw7XG4gICAgICAgICAgICBzY29wZS5leGFtcGxlQ291bnQgPSBudWxsO1xuICAgICAgICAgICAgc2NvcGUuc2VlQ291bnQgPSBudWxsO1xuICAgICAgICAgICAgc2NvcGUuaGVhckNvdW50ID0gbnVsbDtcbiAgICAgICAgICAgIHNjb3BlLmJyZWFrQ291bnQgPSBudWxsO1xuICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpO1xuICAgICAgICAgIH0sIDMwKjEwMDApXG4gICAgICAgIH0pXG4gICAgICB9XG5cbiAgICAgIGVsc2Uge1xuICAgICAgICBzY29wZS5yZWplY3RNZXNzYWdlID0gdHJ1ZVxuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgc2NvcGUucmVqZWN0TWVzc2FnZSA9IGZhbHNlO1xuICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTtcbiAgICAgICAgfSwgMTUwMCk7ICAgICAgICBcbiAgICAgIH1cbiAgICB9XG5cbiAgICBzb2NrZXQub24oJ3VwZGF0ZUZlZWRiYWNrJywgZnVuY3Rpb24oY2F0ZWdvcnkpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ3JlY2VpdmVkIC0tPicsIGNhdGVnb3J5KVxuXG4gICAgICAgIHJldHVybiBGZWVkYmFja0ZhY3RvcnkuY291bnRGZWVkYmFjayhjYXRlZ29yeSkgXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsgICAgICAgICAgXG4gICAgICAgICAgaWYgKGNhdGVnb3J5ID09PSAnR3JlYXQnKSB7XG4gICAgICAgICAgICBzY29wZS5ncmVhdENvdW50ID0gcmVzdWx0XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjYXRlZ29yeSA9PT0gJ0NvbmZ1c2VkJykge1xuICAgICAgICAgICAgc2NvcGUuY29uZnVzZWRDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdFeGFtcGxlJykge1xuICAgICAgICAgICAgc2NvcGUuZXhhbXBsZUNvdW50ID0gcmVzdWx0XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjYXRlZ29yeSA9PT0gJ0Nhbm5vdCBTZWUnKSB7XG4gICAgICAgICAgICBzY29wZS5zZWVDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdDYW5ub3QgSGVhcicpIHtcbiAgICAgICAgICAgIHNjb3BlLmhlYXJDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdSZXF1ZXN0IEJyZWFrJykge1xuICAgICAgICAgICAgc2NvcGUuYnJlYWtDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBzY29wZS5ncmVhdENvdW50ID0gbnVsbDtcbiAgICAgICAgICAgIHNjb3BlLmNvbmZ1c2VkQ291bnQgPSBudWxsO1xuICAgICAgICAgICAgc2NvcGUuZXhhbXBsZUNvdW50ID0gbnVsbDtcbiAgICAgICAgICAgIHNjb3BlLnNlZUNvdW50ID0gbnVsbDtcbiAgICAgICAgICAgIHNjb3BlLmhlYXJDb3VudCA9IG51bGw7XG4gICAgICAgICAgICBzY29wZS5icmVha0NvdW50ID0gbnVsbDtcbiAgICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTtcbiAgICAgICAgICB9LCAzMCoxMDAwKVxuICAgICAgICB9KVxuICAgICAgICAvLyBzY29wZS4kZGlnZXN0KClcbiAgICB9KVxuXG4gIH1cbn1cbn0pXG4iLCJhcHAuZmFjdG9yeSgnRmVlZGJhY2tGYWN0b3J5JywgZnVuY3Rpb24gKCRodHRwKSB7XG5cdHZhciBGZWVkYmFja0ZhY3RvcnkgPSB7fTtcblxuXHRGZWVkYmFja0ZhY3RvcnkuYWRkRmVlZGJhY2sgPSBmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcblx0XHRyZXR1cm4gJGh0dHAucG9zdCgnL2FwaS9mZWVkYmFjay8nLCB7Y2F0ZWdvcnk6IGNhdGVnb3J5fSlcblx0XHQudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcblx0XHRcdGNvbnNvbGUubG9nKCdnb3RIRVJFJywgcmVzdWx0KVxuXHRcdH0pXG5cdH1cblxuXHRGZWVkYmFja0ZhY3RvcnkuY291bnRGZWVkYmFjayA9IGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuXHRcdHJldHVybiAkaHR0cC5nZXQoJy9hcGkvZmVlZGJhY2svY291bnQvJysgY2F0ZWdvcnkpXG5cdFx0LnRoZW4oZnVuY3Rpb24ocmVzdWx0ICkge1xuXHRcdFx0cmV0dXJuIHJlc3VsdC5kYXRhXG5cdFx0fSlcblx0fVxuXG5cdHJldHVybiBGZWVkYmFja0ZhY3Rvcnlcbn0pIiwiYXBwLmRpcmVjdGl2ZSgncG9sbCcsICgkc3RhdGUsIFBvbGxGYWN0b3J5KSA9PiB7XG4gIHJldHVybiB7XG4gICAgcmVzdHJpY3Q6ICdFJyxcbiAgICBzY29wZToge1xuICAgICAgdXNlQ3RybDogXCJAXCJcbiAgICB9LFxuICAgIHRlbXBsYXRlVXJsOiAnanMvY29tbW9uL3BvbGwvcG9sbC5odG1sJyxcbiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSkge1xuXG4gICAgICBzY29wZS5kZWxldGUgPSBQb2xsRmFjdG9yeS5kZWxldGVQb2xsXG5cbiAgICAgIFBvbGxGYWN0b3J5LmdldEFsbEJ5TGVjdHVyZUlkKDEpXG4gICAgICAudGhlbigoY3VycmVudFBvbGxzKSA9PiB7XG4gICAgICAgIHNjb3BlLnBvbGxzID0gY3VycmVudFBvbGxzXG4gICAgICB9KVxuXG5cbiAgICB9XG4gIH1cbn0pXG4iLCJhcHAuZmFjdG9yeSgnUG9sbEZhY3RvcnknLCAoJGh0dHApID0+IHtcbiAgZnVuY3Rpb24gZG90RGF0YShkb3QpIHtcbiAgICByZXR1cm4gZG90LmRhdGFcbiAgfVxuICB2YXIgY2FjaGVkUG9sbHMgPSBbXVxuICByZXR1cm4ge1xuICAgIGdldEFsbEJ5TGVjdHVyZUlkOiAoaWQpID0+IHtcbiAgICAgIHJldHVybiAkaHR0cC5nZXQoJy9hcGkvcG9sbC9sZWN0dXJlLycraWQpXG4gICAgICAudGhlbihkb3REYXRhKVxuICAgICAgLnRoZW4oKHBvbGxzKSA9PiB7XG4gICAgICAgIGFuZ3VsYXIuY29weShwb2xscywgY2FjaGVkUG9sbHMpXG4gICAgICAgIHJldHVybiBjYWNoZWRQb2xsc1xuICAgICAgfSlcbiAgICB9LFxuICAgIGdldE9uZUJ5UG9sbElkOiAoaWQpID0+IHtcbiAgICAgIHJldHVybiAkaHR0cC5nZXQoJy9hcGkvcG9sbC8nK2lkKVxuICAgICAgLnRoZW4oZG90RGF0YSlcbiAgICB9LFxuICAgIGNyZWF0ZVBvbGw6IChwb2xsT2JqKSA9PiB7XG4gICAgICByZXR1cm4gJGh0dHAucG9zdCgnL2FwaS9wb2xsLycsIHBvbGxPYmopXG4gICAgICAudGhlbihkb3REYXRhKVxuICAgIH0sXG4gICAgdXBkYXRlUG9sbDogKHBvbGxPYmosIGlkKSA9PiB7XG4gICAgICByZXR1cm4gJGh0dHAucHV0KCcvYXBpL3BvbGwvJytpZCwgcG9sbE9iailcbiAgICAgIC50aGVuKGRvdERhdGEpXG4gICAgfSxcbiAgICBkZWxldGVQb2xsOiAoaWQpID0+IHtcbiAgICAgIHJldHVybiAkaHR0cC5kZWxldGUoJy9hcGkvcG9sbC8nK2lkKVxuICAgICAgLnRoZW4oZG90RGF0YSlcbiAgICAgIC50aGVuKChyZW1vdmVkUG9sbCkgPT4ge1xuICAgICAgICBjYWNoZWRQb2xscy5zcGxpY2UoY2FjaGVkUG9sbHMubWFwKGZ1bmN0aW9uKGl0ZW0pIHsgcmV0dXJuIGl0ZW0uaWQgfSkuaW5kZXhPZihpZCksMSlcbiAgICAgICAgcmV0dXJuIGNhY2hlZFBvbGxzXG4gICAgICB9KVxuICAgIH1cbiAgfVxufSlcbiIsImFwcC5kaXJlY3RpdmUoJ3F1ZXN0aW9uJywgZnVuY3Rpb24oJHN0YXRlLCBRdWVzdGlvbkZhY3RvcnkpIHtcblxuICAgIHJldHVybiB7XG4gICAgICAgIHJlc3RyaWN0OiAnRScsXG4gICAgICAgIHNjb3BlOiB7XG4gICAgICAgICAgICBcbiAgICAgICAgfSxcbiAgICAgICAgdGVtcGxhdGVVcmw6ICdqcy9jb21tb24vcXVlc3Rpb24vcXVlc3Rpb24uaHRtbCcsXG4gICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlKSB7XG4gICAgICAgICAgICBRdWVzdGlvbkZhY3RvcnkuZ2V0QWxsQnlMZWN0dXJlSWQoMSkudGhlbihmdW5jdGlvbihxdWVzdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBzY29wZS5xdWVzdGlvbnMgPSBxdWVzdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKHEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHEuc3RhdHVzID09PSAnb3BlbidcbiAgICAgICAgICAgICAgICB9KS5tYXAoZnVuY3Rpb24ocSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcS5oYXNVcHZvdGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIGZ1bmN0aW9uIGZpbmRJbmRleChxdWVzdGlvbikge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2NvcGUucXVlc3Rpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzY29wZS5xdWVzdGlvbnNbaV0udGV4dCA9PT0gcXVlc3Rpb24udGV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2NvcGUubmV3UXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHF1ZXN0aW9uID0ge3RleHQ6IHNjb3BlLm5ld1F1ZXN0aW9uLCBzdWJtaXRUaW1lOiBEYXRlLm5vdygpLCB1cHZvdGVzOiAwfVxuICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgnYWRkaW5nUXVlc3Rpb24nLCBxdWVzdGlvbilcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUubmV3UXVlc3Rpb24gPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2NvcGUuZGVsZXRlID0gZnVuY3Rpb24ocXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgnZGVsZXRpbmdRdWVzdGlvbicsIHF1ZXN0aW9uKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzY29wZS5zdG9yZSA9IGZ1bmN0aW9uKHF1ZXN0aW9uLCBzdGF0dXMpIHtcbiAgICAgICAgICAgICAgICBxdWVzdGlvbi5zdGF0dXMgPSBzdGF0dXNcbiAgICAgICAgICAgICAgICBRdWVzdGlvbkZhY3Rvcnkuc3RvcmUocXVlc3Rpb24pLnRoZW4oZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUuZGVsZXRlKHF1ZXN0aW9uKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNjb3BlLnVwdm90ZSA9IGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgc29ja2V0LmVtaXQoJ3Vwdm90aW5nJywgcXVlc3Rpb24pXG4gICAgICAgICAgICAgICAgcXVlc3Rpb24uaGFzVXB2b3RlZCA9ICFxdWVzdGlvbi5oYXNVcHZvdGVkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzY29wZS5kb3dudm90ZSA9IGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgc29ja2V0LmVtaXQoJ2Rvd252b3RpbmcnLCBxdWVzdGlvbilcbiAgICAgICAgICAgICAgICBxdWVzdGlvbi5oYXNVcHZvdGVkID0gIXF1ZXN0aW9uLmhhc1Vwdm90ZWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNvY2tldC5vbignYWRkUXVlc3Rpb24nLCBmdW5jdGlvbihxdWVzdGlvbikge1xuICAgICAgICAgICAgICAgIHNjb3BlLnF1ZXN0aW9ucy51bnNoaWZ0KHF1ZXN0aW9uKVxuICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsQXN5bmMoKVxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgc29ja2V0Lm9uKCdkZWxldGVRdWVzdGlvbicsIGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZmluZEluZGV4KHF1ZXN0aW9uKVxuICAgICAgICAgICAgICAgIHNjb3BlLnF1ZXN0aW9ucy5zcGxpY2UoaW5kZXgsIDEpXG4gICAgICAgICAgICAgICAgc2NvcGUuJGV2YWxBc3luYygpXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBzb2NrZXQub24oJ3JlY2VpdmVkVXB2b3RlJywgZnVuY3Rpb24ocXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kSW5kZXgocXVlc3Rpb24pXG4gICAgICAgICAgICAgICAgdmFyIHEgPSBzY29wZS5xdWVzdGlvbnNbaW5kZXhdXG4gICAgICAgICAgICAgICAgcS51cHZvdGVzID8gcS51cHZvdGVzKysgOiBxLnVwdm90ZXMgPSAxO1xuICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsQXN5bmMoKVxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgc29ja2V0Lm9uKCdyZWNlaXZlZERvd252b3RlJywgZnVuY3Rpb24ocXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kSW5kZXgocXVlc3Rpb24pXG4gICAgICAgICAgICAgICAgdmFyIHEgPSBzY29wZS5xdWVzdGlvbnNbaW5kZXhdXG4gICAgICAgICAgICAgICAgcS51cHZvdGVzLS07XG4gICAgICAgICAgICAgICAgc2NvcGUuJGV2YWxBc3luYygpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgfVxufSk7XG4iLCJhcHAuZmFjdG9yeSgnUXVlc3Rpb25GYWN0b3J5JywgZnVuY3Rpb24gKCRodHRwKSB7XG5cblx0dmFyIG9iaiA9IHt9O1xuXG5cdG9iai5nZXRBbGxCeUxlY3R1cmVJZCA9IGZ1bmN0aW9uKGxlY3R1cmVJZCkge1xuXHRcdHJldHVybiAkaHR0cC5nZXQoJy9hcGkvcXVlc3Rpb24vbGVjdHVyZS8nICsgbGVjdHVyZUlkKS50aGVuKGZ1bmN0aW9uKHJlcykge1xuXHRcdFx0cmV0dXJuIHJlcy5kYXRhO1xuXHRcdH0pXG5cdH1cblxuXHRvYmouc3RvcmUgPSBmdW5jdGlvbihxdWVzdGlvbikge1xuXHRcdHJldHVybiAkaHR0cC5wb3N0KCcvYXBpL3F1ZXN0aW9uJywgcXVlc3Rpb24pLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG5cdFx0XHRyZXR1cm4gcmVzLmRhdGE7XG5cdFx0fSlcblx0fVxuXG5cdHJldHVybiBvYmo7XG5cbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
