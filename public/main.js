'use strict';

window.app = angular.module('MyApp', ['ui.router', 'ui.bootstrap', 'ngAnimate', 'ngKookies']);

app.config(function ($urlRouterProvider, $locationProvider, $kookiesProvider) {
  // This turns off hashbang urls (/#about) and changes it to something normal (/about)
  $locationProvider.html5Mode(true);
  // If we go to a URL that ui-router doesn't have registered, go to the "/" url.
  $urlRouterProvider.otherwise('/');
  // Trigger page refresh when accessing an OAuth route
  $urlRouterProvider.when('/auth/:provider', function () {
    window.location.reload();
  });

  $kookiesProvider.config.json = true;
});

app.config(function ($stateProvider) {
  $stateProvider.state('student', {
    url: '/student',
    templateUrl: 'js/views/student/student.html'
  });
});

app.config(function ($stateProvider) {
  $stateProvider.state('admin', {
    url: '/admin',
    templateUrl: 'js/views/instructor/instructor.html'
  });
});

app.controller('LoginCtrl', function ($scope, $state) {

  console.log("reached login ctrl");
  $scope.loginStatus = function () {
    console.log("reached login status");
    var temp = $scope.login;
    console.log("temp: ", temp);

    if (temp === 'admin') {
      $state.go('admin');
    } else if (temp === 'student') {
      $state.go('student');
    }
  };
});

var socket = io(window.location.origin);
app.controller('CreatePoll', function ($scope, $uibModal) {

  $scope.showModal = function () {

    $scope.opts = {
      backdrop: true,
      backdropClick: true,
      transclude: true,
      dialogFade: false,
      keyboard: true,
      templateUrl: 'js/common/createPollModal/createPollModal.html',
      controller: ModalInstanceCtrl,
      resolve: {} // empty storage
    };

    $scope.opts.resolve.item = function () {
      return angular.copy({ polls: $scope.polls }); // pass name to Dialog
    };

    var modalInstance = $uibModal.open($scope.opts);

    modalInstance.result.then(function () {
      //on ok button press
    }, function () {
      //on cancel button press
      console.log("Modal Closed");
    });
  };
});

var ModalInstanceCtrl = function ModalInstanceCtrl($scope, $uibModalInstance, $uibModal, item, PollFactory) {

  $scope.item = item;

  $scope.customOptions = function (option) {
    $scope.customShow = option === 'custom';
  };

  $scope.submitPoll = function () {
    var poll = {};
    poll.question = $scope.newPoll;
    poll.lectureId = 1;
    if ($scope.option == 'custom') poll.options = [$scope.a, $scope.b, $scope.c, $scope.d];

    PollFactory.createPoll(poll).then(function () {
      return PollFactory.getAllByLectureId(1);
    }).then(function (polls) {
      $scope.polls = polls;
    }).then(function () {
      $uibModalInstance.close();
    });
  };

  $scope.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };
};

app.directive('feedback', function ($state, FeedbackFactory) {
  return {
    restrict: 'E',
    scope: {},
    templateUrl: 'js/common/feedback/feedback.html',
    link: function link(scope) {
      scope.addMessage = false;

      scope.countFeedback = function (category) {
        return FeedbackFactory.addFeedback(category).then(function () {
          return FeedbackFactory.countFeedback(category);
        }).then(function (result) {
          console.log('IT IS HERE', result);
          if (category === 'Great') {
            scope.greatCount = result;
          }
          if (category === 'Confused') {
            scope.confusedCount = result;
          }
          if (category === 'Example') {
            scope.exampleCount = result;
          }
        }).then(function () {
          scope.addMessage = true;
          setTimeout(function () {
            scope.addMessage = false;
            scope.$digest();
          }, 1000);
        }).then(function () {
          setTimeout(function () {
            scope.greatCount = null;
            scope.confusedCount = null;
            scope.exampleCount = null;
            scope.$digest();
          }, 30 * 1000);
        });
      };

      // scope.countConfusedFeedback = function () {
      //   return FeedbackFactory.countFeedback('Confused')
      //   .then(function (result) {
      //     scope.confusedCount = result
      //   })
      //   .then(function () {
      //     setTimeout(function() {
      //       scope.greatCount = null
      //       scope.$digest();
      //     }, 30*1000)
      //   })
      // }

      // scope.countExampleFeedback = function () {
      //   return FeedbackFactory.countFeedback('Example')
      //   .then(function (result) {
      //     scope.exampleCount = result
      //   })
      //   .then(function () {
      //     setTimeout(function() {
      //       scope.greatCount = null
      //       scope.$digest();
      //     }, 30*1000)
      //   })
      // }
    }
  };
});

app.factory('FeedbackFactory', function ($http) {
  var FeedbackFactory = {};

  FeedbackFactory.addFeedback = function (category) {
    return $http.post('/api/feedback/', { category: category }).then(function (result) {
      console.log('gotHERE', result);
    });
  };

  FeedbackFactory.countFeedback = function (category) {
    return $http.get('/api/feedback/count/' + category).then(function (result) {
      return result.data;
    });
  };

  return FeedbackFactory;
});
app.directive('poll', function ($state, PollFactory) {
  return {
    restrict: 'E',
    scope: {
      useCtrl: "@"
    },
    templateUrl: 'js/common/poll/poll.html',
    link: function link(scope) {

      scope.delete = PollFactory.deletePoll;

      PollFactory.getAllByLectureId(1).then(function (currentPolls) {
        scope.polls = currentPolls;
      });
    }
  };
});

app.factory('PollFactory', function ($http) {
  function dotData(dot) {
    return dot.data;
  }
  var cachedPolls = [];
  return {
    getAllByLectureId: function getAllByLectureId(id) {
      return $http.get('/api/poll/lecture/' + id).then(dotData).then(function (polls) {
        angular.copy(polls, cachedPolls);
        return cachedPolls;
      });
    },
    getOneByPollId: function getOneByPollId(id) {
      return $http.get('/api/poll/' + id).then(dotData);
    },
    createPoll: function createPoll(pollObj) {
      return $http.post('/api/poll/', pollObj).then(dotData);
    },
    updatePoll: function updatePoll(pollObj, id) {
      return $http.put('/api/poll/' + id, pollObj).then(dotData);
    },
    deletePoll: function deletePoll(id) {
      return $http.delete('/api/poll/' + id).then(dotData).then(function (removedPoll) {
        cachedPolls.splice(cachedPolls.map(function (item) {
          return item.id;
        }).indexOf(id), 1);
        return cachedPolls;
      });
    }
  };
});

app.directive('question', function ($state, QuestionFactory) {

  return {
    restrict: 'E',
    scope: {},
    templateUrl: 'js/common/question/question.html',
    link: function link(scope) {

      QuestionFactory.getAllByLectureId(1).then(function (questions) {
        scope.questions = questions.filter(function (q) {
          return q.status === 'open';
        });
      });

      function findIndex(question) {
        for (var i = 0; i < scope.questions.length; i++) {
          if (scope.questions[i].text === question.text) {
            return i;
          }
        }
        return -1;
      }

      function move(question, n) {
        var index = findIndex(question);
        if (index + n > -1 && index + n < scope.questions.length) {
          scope.questions.splice(index, 1);
          scope.questions.splice(index + n, 0, question);
        }
      }

      scope.submit = function () {
        if (scope.newQuestion) {
          var question = { text: scope.newQuestion, submitTime: Date.now(), upvotes: 0 };
          return QuestionFactory.store(question).then(function (q) {
            socket.emit('addingQuestion', q);
            scope.newQuestion = null;
          });
        }
      };

      scope.delete = function (question) {
        socket.emit('deletingQuestion', question);
        return QuestionFactory.delete(question);
      };

      scope.close = function (question) {
        question.status = 'closed';
        return QuestionFactory.update(question).then(function () {
          socket.emit('deletingQuestion', question);
        });
      };

      scope.move = function (question, n) {
        socket.emit('move', question, n);
      };

      scope.upvote = function (question) {
        question.hasUpvoted = !question.hasUpvoted;
        question.upvotes++;
        socket.emit('upvoting', question);
        return QuestionFactory.update(question);
      };

      scope.downvote = function (question) {
        question.hasUpvoted = !question.hasUpvoted;
        question.upvotes--;
        socket.emit('downvoting', question);
        return QuestionFactory.update(question);
      };

      socket.on('addQuestion', function (question) {
        scope.questions.unshift(question);
        scope.$evalAsync();
      });

      socket.on('deleteQuestion', function (question) {
        var index = findIndex(question);
        scope.questions.splice(index, 1);
        scope.$evalAsync();
      });

      socket.on('receivedUpvote', function (question) {
        var index = findIndex(question);
        var question = scope.questions[index];
        question.upvotes++;
        scope.$evalAsync();
      });

      socket.on('receivedDownvote', function (question) {
        var index = findIndex(question);
        var question = scope.questions[index];
        question.upvotes--;
        scope.$evalAsync();
      });

      socket.on('moving', function (question, n) {
        move(question, n);
        scope.$evalAsync();
      });
    }
  };
});

app.factory('QuestionFactory', function ($http) {

  var obj = {};

  obj.getAllByLectureId = function (lectureId) {
    return $http.get('/api/question/lecture/' + lectureId).then(function (res) {
      return res.data;
    });
  };

  obj.store = function (question) {
    return $http.post('/api/question', question).then(function (res) {
      return res.data;
    });
  };

  obj.update = function (question) {
    return $http.put('/api/question/' + question.id, question).then(function (res) {
      return res.data;
    });
  };

  obj.delete = function (question) {
    return $http.delete('/api/question/' + question.id).then(function (res) {
      return res.data;
    });
  };

  return obj;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsInNvY2tldC5qcyIsImNvbW1vbi9jcmVhdGVQb2xsTW9kYWwvY3JlYXRlUG9sbC5jb250cm9sbGVyLmpzIiwiY29tbW9uL2ZlZWRiYWNrL2ZlZWRiYWNrLmRpcmVjdGl2ZS5qcyIsImNvbW1vbi9mZWVkYmFjay9mZWVkYmFjay5mYWN0b3J5LmpzIiwiY29tbW9uL3BvbGwvcG9sbC5kaXJlY3RpdmUuanMiLCJjb21tb24vcG9sbC9wb2xsLmZhY3RvcnkuanMiLCJjb21tb24vcXVlc3Rpb24vcXVlc3Rpb24uZGlyZWN0aXZlLmpzIiwiY29tbW9uL3F1ZXN0aW9uL3F1ZXN0aW9uLmZhY3RvcnkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsT0FBQSxHQUFBLEdBQUEsUUFBQSxNQUFBLENBQUEsT0FBQSxFQUFBLENBQUEsV0FBQSxFQUFBLGNBQUEsRUFBQSxXQUFBLEVBQUEsV0FBQSxDQUFBLENBQUE7O0FBRUEsSUFBQSxNQUFBLENBQUEsVUFBQSxrQkFBQSxFQUFBLGlCQUFBLEVBQUEsZ0JBQUEsRUFBQTs7QUFFQSxvQkFBQSxTQUFBLENBQUEsSUFBQTs7QUFFQSxxQkFBQSxTQUFBLENBQUEsR0FBQTs7QUFFQSxxQkFBQSxJQUFBLENBQUEsaUJBQUEsRUFBQSxZQUFBO0FBQ0EsV0FBQSxRQUFBLENBQUEsTUFBQTtBQUNBLEdBRkE7O0FBSUEsbUJBQUEsTUFBQSxDQUFBLElBQUEsR0FBQSxJQUFBO0FBRUEsQ0FaQTs7QUFjQSxJQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGlCQUFBLEtBQUEsQ0FBQSxTQUFBLEVBQUE7QUFDQSxTQUFBLFVBREE7QUFFQSxpQkFBQTtBQUZBLEdBQUE7QUFJQSxDQUxBOztBQU9BLElBQUEsTUFBQSxDQUFBLFVBQUEsY0FBQSxFQUFBO0FBQ0EsaUJBQUEsS0FBQSxDQUFBLE9BQUEsRUFBQTtBQUNBLFNBQUEsUUFEQTtBQUVBLGlCQUFBO0FBRkEsR0FBQTtBQUlBLENBTEE7O0FBT0EsSUFBQSxVQUFBLENBQUEsV0FBQSxFQUFBLFVBQUEsTUFBQSxFQUFBLE1BQUEsRUFBQTs7QUFFQSxVQUFBLEdBQUEsQ0FBQSxvQkFBQTtBQUNBLFNBQUEsV0FBQSxHQUFBLFlBQUE7QUFDQSxZQUFBLEdBQUEsQ0FBQSxzQkFBQTtBQUNBLFFBQUEsT0FBQSxPQUFBLEtBQUE7QUFDQSxZQUFBLEdBQUEsQ0FBQSxRQUFBLEVBQUEsSUFBQTs7QUFFQSxRQUFBLFNBQUEsT0FBQSxFQUFBO0FBQ0EsYUFBQSxFQUFBLENBQUEsT0FBQTtBQUNBLEtBRkEsTUFHQSxJQUFBLFNBQUEsU0FBQSxFQUFBO0FBQ0EsYUFBQSxFQUFBLENBQUEsU0FBQTtBQUNBO0FBQ0EsR0FYQTtBQWFBLENBaEJBOztBQ2hDQSxJQUFBLFNBQUEsR0FBQSxPQUFBLFFBQUEsQ0FBQSxNQUFBLENBQUE7QUNBQSxJQUFBLFVBQUEsQ0FBQSxZQUFBLEVBQUEsVUFBQSxNQUFBLEVBQUEsU0FBQSxFQUFBOztBQUVBLFNBQUEsU0FBQSxHQUFBLFlBQUE7O0FBRUEsV0FBQSxJQUFBLEdBQUE7QUFDQSxnQkFBQSxJQURBO0FBRUEscUJBQUEsSUFGQTtBQUdBLGtCQUFBLElBSEE7QUFJQSxrQkFBQSxLQUpBO0FBS0EsZ0JBQUEsSUFMQTtBQU1BLG1CQUFBLGdEQU5BO0FBT0Esa0JBQUEsaUJBUEE7QUFRQSxlQUFBLEU7QUFSQSxLQUFBOztBQVdBLFdBQUEsSUFBQSxDQUFBLE9BQUEsQ0FBQSxJQUFBLEdBQUEsWUFBQTtBQUNBLGFBQUEsUUFBQSxJQUFBLENBQUEsRUFBQSxPQUFBLE9BQUEsS0FBQSxFQUFBLENBQUEsQztBQUNBLEtBRkE7O0FBSUEsUUFBQSxnQkFBQSxVQUFBLElBQUEsQ0FBQSxPQUFBLElBQUEsQ0FBQTs7QUFFQSxrQkFBQSxNQUFBLENBQUEsSUFBQSxDQUFBLFlBQUE7O0FBRUEsS0FGQSxFQUVBLFlBQUE7O0FBRUEsY0FBQSxHQUFBLENBQUEsY0FBQTtBQUNBLEtBTEE7QUFNQSxHQXpCQTtBQTJCQSxDQTdCQTs7QUErQkEsSUFBQSxvQkFBQSxTQUFBLGlCQUFBLENBQUEsTUFBQSxFQUFBLGlCQUFBLEVBQUEsU0FBQSxFQUFBLElBQUEsRUFBQSxXQUFBLEVBQUE7O0FBRUEsU0FBQSxJQUFBLEdBQUEsSUFBQTs7QUFFQSxTQUFBLGFBQUEsR0FBQSxVQUFBLE1BQUEsRUFBQTtBQUNBLFdBQUEsVUFBQSxHQUFBLFdBQUEsUUFBQTtBQUNBLEdBRkE7O0FBSUEsU0FBQSxVQUFBLEdBQUEsWUFBQTtBQUNBLFFBQUEsT0FBQSxFQUFBO0FBQ0EsU0FBQSxRQUFBLEdBQUEsT0FBQSxPQUFBO0FBQ0EsU0FBQSxTQUFBLEdBQUEsQ0FBQTtBQUNBLFFBQUEsT0FBQSxNQUFBLElBQUEsUUFBQSxFQUFBLEtBQUEsT0FBQSxHQUFBLENBQUEsT0FBQSxDQUFBLEVBQUEsT0FBQSxDQUFBLEVBQUEsT0FBQSxDQUFBLEVBQUEsT0FBQSxDQUFBLENBQUE7O0FBRUEsZ0JBQUEsVUFBQSxDQUFBLElBQUEsRUFDQSxJQURBLENBQ0EsWUFBQTtBQUFBLGFBQUEsWUFBQSxpQkFBQSxDQUFBLENBQUEsQ0FBQTtBQUFBLEtBREEsRUFFQSxJQUZBLENBRUEsVUFBQSxLQUFBLEVBQUE7QUFBQSxhQUFBLEtBQUEsR0FBQSxLQUFBO0FBQUEsS0FGQSxFQUdBLElBSEEsQ0FHQSxZQUFBO0FBQUEsd0JBQUEsS0FBQTtBQUFBLEtBSEE7QUFJQSxHQVZBOztBQVlBLFNBQUEsTUFBQSxHQUFBLFlBQUE7QUFDQSxzQkFBQSxPQUFBLENBQUEsUUFBQTtBQUNBLEdBRkE7QUFHQSxDQXZCQTs7QUMvQkEsSUFBQSxTQUFBLENBQUEsVUFBQSxFQUFBLFVBQUEsTUFBQSxFQUFBLGVBQUEsRUFBQTtBQUNBLFNBQUE7QUFDQSxjQUFBLEdBREE7QUFFQSxXQUFBLEVBRkE7QUFLQSxpQkFBQSxrQ0FMQTtBQU1BLFVBQUEsY0FBQSxLQUFBLEVBQUE7QUFDQSxZQUFBLFVBQUEsR0FBQSxLQUFBOztBQUVBLFlBQUEsYUFBQSxHQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsZUFBQSxnQkFBQSxXQUFB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QSxJQUFBLElBQUEsQ0FBQSxFQUFBLElBQUEsTUFBQSxTQUFBLENBQUEsTUFBQSxFQUFBLEdBQUEsRUFBQTtBQUNBLGNBQUEsTUFBQSxTQUFBLENBQUEsQ0FBQSxFQUFBLElBQUEsS0FBQSxTQUFBLElBQUEsRUFBQTtBQUNBLG1CQUFBLENBQUE7QUFDQTtBQUNBO0FBQ0EsZUFBQSxDQUFBLENBQUE7QUFDQTs7QUFFQSxlQUFBLElBQUEsQ0FBQSxRQUFBLEVBQUEsQ0FBQSxFQUFBO0FBQ0EsWUFBQSxRQUFBLFVBQUEsUUFBQSxDQUFBO0FBQ0EsWUFBQSxRQUFBLENBQUEsR0FBQSxDQUFBLENBQUEsSUFBQSxRQUFBLENBQUEsR0FBQSxNQUFBLFNBQUEsQ0FBQSxNQUFBLEVBQUE7QUFDQSxnQkFBQSxTQUFBLENBQUEsTUFBQSxDQUFBLEtBQUEsRUFBQSxDQUFBO0FBQ0EsZ0JBQUEsU0FBQSxDQUFBLE1BQUEsQ0FBQSxRQUFBLENBQUEsRUFBQSxDQUFBLEVBQUEsUUFBQTtBQUNBO0FBQ0E7O0FBRUEsWUFBQSxNQUFBLEdBQUEsWUFBQTtBQUNBLFlBQUEsTUFBQSxXQUFBLEVBQUE7QUFDQSxjQUFBLFdBQUEsRUFBQSxNQUFBLE1BQUEsV0FBQSxFQUFBLFlBQUEsS0FBQSxHQUFBLEVBQUEsRUFBQSxTQUFBLENBQUEsRUFBQTtBQUNBLGlCQUFBLGdCQUFBLEtBQUEsQ0FBQSxRQUFBLEVBQUEsSUFBQSxDQUFBLFVBQUEsQ0FBQSxFQUFBO0FBQ0EsbUJBQUEsSUFBQSxDQUFBLGdCQUFBLEVBQUEsQ0FBQTtBQUNBLGtCQUFBLFdBQUEsR0FBQSxJQUFBO0FBQ0EsV0FIQSxDQUFBO0FBSUE7QUFDQSxPQVJBOztBQVVBLFlBQUEsTUFBQSxHQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsZUFBQSxJQUFBLENBQUEsa0JBQUEsRUFBQSxRQUFBO0FBQ0EsZUFBQSxnQkFBQSxNQUFBLENBQUEsUUFBQSxDQUFBO0FBQ0EsT0FIQTs7QUFLQSxZQUFBLEtBQUEsR0FBQSxVQUFBLFFBQUEsRUFBQTtBQUNBLGlCQUFBLE1BQUEsR0FBQSxRQUFBO0FBQ0EsZUFBQSxnQkFBQSxNQUFBLENBQUEsUUFBQSxFQUFBLElBQUEsQ0FBQSxZQUFBO0FBQ0EsaUJBQUEsSUFBQSxDQUFBLGtCQUFBLEVBQUEsUUFBQTtBQUNBLFNBRkEsQ0FBQTtBQUdBLE9BTEE7O0FBT0EsWUFBQSxJQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUEsQ0FBQSxFQUFBO0FBQ0EsZUFBQSxJQUFBLENBQUEsTUFBQSxFQUFBLFFBQUEsRUFBQSxDQUFBO0FBQ0EsT0FGQTs7QUFJQSxZQUFBLE1BQUEsR0FBQSxVQUFBLFFBQUEsRUFBQTtBQUNBLGlCQUFBLFVBQUEsR0FBQSxDQUFBLFNBQUEsVUFBQTtBQUNBLGlCQUFBLE9BQUE7QUFDQSxlQUFBLElBQUEsQ0FBQSxVQUFBLEVBQUEsUUFBQTtBQUNBLGVBQUEsZ0JBQUEsTUFBQSxDQUFBLFFBQUEsQ0FBQTtBQUNBLE9BTEE7O0FBT0EsWUFBQSxRQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxpQkFBQSxVQUFBLEdBQUEsQ0FBQSxTQUFBLFVBQUE7QUFDQSxpQkFBQSxPQUFBO0FBQ0EsZUFBQSxJQUFBLENBQUEsWUFBQSxFQUFBLFFBQUE7QUFDQSxlQUFBLGdCQUFBLE1BQUEsQ0FBQSxRQUFBLENBQUE7QUFDQSxPQUxBOztBQU9BLGFBQUEsRUFBQSxDQUFBLGFBQUEsRUFBQSxVQUFBLFFBQUEsRUFBQTtBQUNBLGNBQUEsU0FBQSxDQUFBLE9BQUEsQ0FBQSxRQUFBO0FBQ0EsY0FBQSxVQUFBO0FBQ0EsT0FIQTs7QUFLQSxhQUFBLEVBQUEsQ0FBQSxnQkFBQSxFQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsWUFBQSxRQUFBLFVBQUEsUUFBQSxDQUFBO0FBQ0EsY0FBQSxTQUFBLENBQUEsTUFBQSxDQUFBLEtBQUEsRUFBQSxDQUFBO0FBQ0EsY0FBQSxVQUFBO0FBQ0EsT0FKQTs7QUFNQSxhQUFBLEVBQUEsQ0FBQSxnQkFBQSxFQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsWUFBQSxRQUFBLFVBQUEsUUFBQSxDQUFBO0FBQ0EsWUFBQSxXQUFBLE1BQUEsU0FBQSxDQUFBLEtBQUEsQ0FBQTtBQUNBLGlCQUFBLE9BQUE7QUFDQSxjQUFBLFVBQUE7QUFDQSxPQUxBOztBQU9BLGFBQUEsRUFBQSxDQUFBLGtCQUFBLEVBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxZQUFBLFFBQUEsVUFBQSxRQUFBLENBQUE7QUFDQSxZQUFBLFdBQUEsTUFBQSxTQUFBLENBQUEsS0FBQSxDQUFBO0FBQ0EsaUJBQUEsT0FBQTtBQUNBLGNBQUEsVUFBQTtBQUNBLE9BTEE7O0FBT0EsYUFBQSxFQUFBLENBQUEsUUFBQSxFQUFBLFVBQUEsUUFBQSxFQUFBLENBQUEsRUFBQTtBQUNBLGFBQUEsUUFBQSxFQUFBLENBQUE7QUFDQSxjQUFBLFVBQUE7QUFDQSxPQUhBO0FBSUE7QUFwR0EsR0FBQTtBQXNHQSxDQXhHQTs7QUNBQSxJQUFBLE9BQUEsQ0FBQSxpQkFBQSxFQUFBLFVBQUEsS0FBQSxFQUFBOztBQUVBLE1BQUEsTUFBQSxFQUFBOztBQUVBLE1BQUEsaUJBQUEsR0FBQSxVQUFBLFNBQUEsRUFBQTtBQUNBLFdBQUEsTUFBQSxHQUFBLENBQUEsMkJBQUEsU0FBQSxFQUFBLElBQUEsQ0FBQSxVQUFBLEdBQUEsRUFBQTtBQUNBLGFBQUEsSUFBQSxJQUFBO0FBQ0EsS0FGQSxDQUFBO0FBR0EsR0FKQTs7QUFNQSxNQUFBLEtBQUEsR0FBQSxVQUFBLFFBQUEsRUFBQTtBQUNBLFdBQUEsTUFBQSxJQUFBLENBQUEsZUFBQSxFQUFBLFFBQUEsRUFBQSxJQUFBLENBQUEsVUFBQSxHQUFBLEVBQUE7QUFDQSxhQUFBLElBQUEsSUFBQTtBQUNBLEtBRkEsQ0FBQTtBQUdBLEdBSkE7O0FBTUEsTUFBQSxNQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxXQUFBLE1BQUEsR0FBQSxDQUFBLG1CQUFBLFNBQUEsRUFBQSxFQUFBLFFBQUEsRUFBQSxJQUFBLENBQUEsVUFBQSxHQUFBLEVBQUE7QUFDQSxhQUFBLElBQUEsSUFBQTtBQUNBLEtBRkEsQ0FBQTtBQUdBLEdBSkE7O0FBTUEsTUFBQSxNQUFBLEdBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxXQUFBLE1BQUEsTUFBQSxDQUFBLG1CQUFBLFNBQUEsRUFBQSxFQUFBLElBQUEsQ0FBQSxVQUFBLEdBQUEsRUFBQTtBQUNBLGFBQUEsSUFBQSxJQUFBO0FBQ0EsS0FGQSxDQUFBO0FBR0EsR0FKQTs7QUFNQSxTQUFBLEdBQUE7QUFFQSxDQTlCQSIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG53aW5kb3cuYXBwID0gYW5ndWxhci5tb2R1bGUoJ015QXBwJywgWyd1aS5yb3V0ZXInLCAndWkuYm9vdHN0cmFwJywgJ25nQW5pbWF0ZScsICduZ0tvb2tpZXMnXSk7XG5cbmFwcC5jb25maWcoZnVuY3Rpb24gKCR1cmxSb3V0ZXJQcm92aWRlciwgJGxvY2F0aW9uUHJvdmlkZXIsICRrb29raWVzUHJvdmlkZXIpIHtcbiAgICAvLyBUaGlzIHR1cm5zIG9mZiBoYXNoYmFuZyB1cmxzICgvI2Fib3V0KSBhbmQgY2hhbmdlcyBpdCB0byBzb21ldGhpbmcgbm9ybWFsICgvYWJvdXQpXG4gICAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpO1xuICAgIC8vIElmIHdlIGdvIHRvIGEgVVJMIHRoYXQgdWktcm91dGVyIGRvZXNuJ3QgaGF2ZSByZWdpc3RlcmVkLCBnbyB0byB0aGUgXCIvXCIgdXJsLlxuICAgICR1cmxSb3V0ZXJQcm92aWRlci5vdGhlcndpc2UoJy8nKTtcbiAgICAvLyBUcmlnZ2VyIHBhZ2UgcmVmcmVzaCB3aGVuIGFjY2Vzc2luZyBhbiBPQXV0aCByb3V0ZVxuICAgICR1cmxSb3V0ZXJQcm92aWRlci53aGVuKCcvYXV0aC86cHJvdmlkZXInLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcbiAgICB9KTtcblxuICAgICRrb29raWVzUHJvdmlkZXIuY29uZmlnLmpzb24gPSB0cnVlO1xuXG59KTtcblxuYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIpIHtcbiAgICAkc3RhdGVQcm92aWRlci5zdGF0ZSgnc3R1ZGVudCcsIHtcbiAgICAgICAgdXJsOiAnL3N0dWRlbnQnLFxuICAgICAgICB0ZW1wbGF0ZVVybDogJ2pzL3ZpZXdzL3N0dWRlbnQvc3R1ZGVudC5odG1sJyxcbiAgICB9KTtcbn0pO1xuXG5hcHAuY29uZmlnKGZ1bmN0aW9uICgkc3RhdGVQcm92aWRlcikge1xuICAgICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdhZG1pbicsIHtcbiAgICAgICAgdXJsOiAnL2FkbWluJyxcbiAgICAgICAgdGVtcGxhdGVVcmw6ICdqcy92aWV3cy9pbnN0cnVjdG9yL2luc3RydWN0b3IuaHRtbCcsXG4gICAgfSk7XG59KTtcblxuYXBwLmNvbnRyb2xsZXIoJ0xvZ2luQ3RybCcsIGZ1bmN0aW9uICgkc2NvcGUsICRzdGF0ZSkge1xuXG5cdGNvbnNvbGUubG9nKFwicmVhY2hlZCBsb2dpbiBjdHJsXCIpO1xuXHQkc2NvcGUubG9naW5TdGF0dXMgPSBmdW5jdGlvbigpe1xuXHRcdGNvbnNvbGUubG9nKFwicmVhY2hlZCBsb2dpbiBzdGF0dXNcIik7XG5cdFx0dmFyIHRlbXAgPSAkc2NvcGUubG9naW47XG5cdFx0Y29uc29sZS5sb2coXCJ0ZW1wOiBcIix0ZW1wKTtcblxuXHRcdGlmICh0ZW1wPT09J2FkbWluJyl7XG5cdFx0XHQkc3RhdGUuZ28oJ2FkbWluJyk7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKHRlbXA9PT0nc3R1ZGVudCcpe1xuXHRcdFx0JHN0YXRlLmdvKCdzdHVkZW50Jyk7XG5cdFx0fVxuXHR9XG5cbn0pO1xuIiwidmFyIHNvY2tldCA9IGlvKHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4pOyIsImFwcC5jb250cm9sbGVyKCdDcmVhdGVQb2xsJywgZnVuY3Rpb24oJHNjb3BlLCAkdWliTW9kYWwpIHtcblxuICAkc2NvcGUuc2hvd01vZGFsID0gZnVuY3Rpb24oKSB7XG5cbiAgICAkc2NvcGUub3B0cyA9IHtcbiAgICBiYWNrZHJvcDogdHJ1ZSxcbiAgICBiYWNrZHJvcENsaWNrOiB0cnVlLFxuICAgIHRyYW5zY2x1ZGU6IHRydWUsXG4gICAgZGlhbG9nRmFkZTogZmFsc2UsXG4gICAga2V5Ym9hcmQ6IHRydWUsXG4gICAgdGVtcGxhdGVVcmwgOiAnanMvY29tbW9uL2NyZWF0ZVBvbGxNb2RhbC9jcmVhdGVQb2xsTW9kYWwuaHRtbCcsXG4gICAgY29udHJvbGxlciA6IE1vZGFsSW5zdGFuY2VDdHJsLFxuICAgIHJlc29sdmU6IHt9IC8vIGVtcHR5IHN0b3JhZ2VcbiAgICAgIH07XG5cbiAgICAkc2NvcGUub3B0cy5yZXNvbHZlLml0ZW0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIGFuZ3VsYXIuY29weSh7cG9sbHM6JHNjb3BlLnBvbGxzfSk7IC8vIHBhc3MgbmFtZSB0byBEaWFsb2dcbiAgICB9XG5cbiAgICAgIHZhciBtb2RhbEluc3RhbmNlID0gJHVpYk1vZGFsLm9wZW4oJHNjb3BlLm9wdHMpO1xuXG4gICAgICBtb2RhbEluc3RhbmNlLnJlc3VsdC50aGVuKGZ1bmN0aW9uKCl7XG4gICAgICAgIC8vb24gb2sgYnV0dG9uIHByZXNzXG4gICAgICB9LGZ1bmN0aW9uKCl7XG4gICAgICAgIC8vb24gY2FuY2VsIGJ1dHRvbiBwcmVzc1xuICAgICAgICBjb25zb2xlLmxvZyhcIk1vZGFsIENsb3NlZFwiKTtcbiAgICAgIH0pXG4gIH1cblxufSlcblxudmFyIE1vZGFsSW5zdGFuY2VDdHJsID0gZnVuY3Rpb24oJHNjb3BlLCAkdWliTW9kYWxJbnN0YW5jZSwgJHVpYk1vZGFsLCBpdGVtLCBQb2xsRmFjdG9yeSkge1xuXG4gICRzY29wZS5pdGVtID0gaXRlbTtcblxuICAkc2NvcGUuY3VzdG9tT3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbikge1xuICAgICRzY29wZS5jdXN0b21TaG93ID0gKG9wdGlvbiA9PT0gJ2N1c3RvbScpXG4gIH1cblxuICAkc2NvcGUuc3VibWl0UG9sbCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcG9sbCA9IHt9XG4gICAgcG9sbC5xdWVzdGlvbiA9ICRzY29wZS5uZXdQb2xsXG4gICAgcG9sbC5sZWN0dXJlSWQgPSAxXG4gICAgaWYgKCRzY29wZS5vcHRpb249PSdjdXN0b20nKSBwb2xsLm9wdGlvbnMgPSBbJHNjb3BlLmEsICRzY29wZS5iLCAkc2NvcGUuYywgJHNjb3BlLmRdXG5cbiAgICBQb2xsRmFjdG9yeS5jcmVhdGVQb2xsKHBvbGwpXG4gICAgLnRoZW4oKCkgPT4geyByZXR1cm4gUG9sbEZhY3RvcnkuZ2V0QWxsQnlMZWN0dXJlSWQoMSkgfSlcbiAgICAudGhlbigocG9sbHMpID0+IHsgJHNjb3BlLnBvbGxzID0gcG9sbHMgfSlcbiAgICAudGhlbigoKSA9PiB7ICR1aWJNb2RhbEluc3RhbmNlLmNsb3NlKCkgfSlcbiAgfVxuXG4gICRzY29wZS5jYW5jZWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgJHVpYk1vZGFsSW5zdGFuY2UuZGlzbWlzcygnY2FuY2VsJyk7XG4gIH1cbn1cbiIsImFwcC5kaXJlY3RpdmUoJ2ZlZWRiYWNrJywgKCRzdGF0ZSwgRmVlZGJhY2tGYWN0b3J5KSA9PiB7XG4gIHJldHVybiB7XG4gICAgcmVzdHJpY3Q6ICdFJyxcbiAgICBzY29wZToge1xuXG4gICAgfSxcbiAgICB0ZW1wbGF0ZVVybDogJ2pzL2NvbW1vbi9mZWVkYmFjay9mZWVkYmFjay5odG1sJyxcbiAgICBsaW5rOiAoc2NvcGUpID0+IHtcbiAgICAgIHNjb3BlLmFkZE1lc3NhZ2UgPSBmYWxzZTtcblxuICAgICAgc2NvcGUuY291bnRGZWVkYmFjayA9IGZ1bmN0aW9uIChjYXRlZ29yeSkge1xuICAgICAgICByZXR1cm4gRmVlZGJhY2tGYWN0b3J5LmFkZEZlZWRiYWNrKGNhdGVnb3J5KVxuICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgcmV0dXJuIEZlZWRiYWNrRmFjdG9yeS5jb3VudEZlZWRiYWNrKGNhdGVnb3J5KVxuICAgICAgICB9KSBcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdJVCBJUyBIRVJFJywgcmVzdWx0KVxuICAgICAgICAgIGlmIChjYXRlZ29yeSA9PT0gJ0dyZWF0Jykge1xuICAgICAgICAgICAgc2NvcGUuZ3JlYXRDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoY2F0ZWdvcnkgPT09ICdDb25mdXNlZCcpIHtcbiAgICAgICAgICAgIHNjb3BlLmNvbmZ1c2VkQ291bnQgPSByZXN1bHRcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGNhdGVnb3J5ID09PSAnRXhhbXBsZScpIHtcbiAgICAgICAgICAgIHNjb3BlLmV4YW1wbGVDb3VudCA9IHJlc3VsdFxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHNjb3BlLmFkZE1lc3NhZ2UgPSB0cnVlXG4gICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgICAgICAgc2NvcGUuYWRkTWVzc2FnZSA9IGZhbHNlO1xuICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpO1xuICAgICAgICAgIH0sIDEwMDApO1xuICAgICAgICB9KVxuICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHNjb3BlLmdyZWF0Q291bnQgPSBudWxsXG4gICAgICAgICAgICBzY29wZS5jb25mdXNlZENvdW50ID0gbnVsbFxuICAgICAgICAgICAgc2NvcGUuZXhhbXBsZUNvdW50ID0gbnVsbFxuICAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpO1xuICAgICAgICAgIH0sIDMwKjEwMDApXG4gICAgICAgIH0pXG4gICAgICB9XG5cbiAgICAgIC8vIHNjb3BlLmNvdW50Q29uZnVzZWRGZWVkYmFjayA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vICAgcmV0dXJuIEZlZWRiYWNrRmFjdG9yeS5jb3VudEZlZWRiYWNrKCdDb25mdXNlZCcpXG4gICAgICAvLyAgIC50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgIC8vICAgICBzY29wZS5jb25mdXNlZENvdW50ID0gcmVzdWx0XG4gICAgICAvLyAgIH0pXG4gICAgICAvLyAgIC50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgLy8gICAgICAgc2NvcGUuZ3JlYXRDb3VudCA9IG51bGxcbiAgICAgIC8vICAgICAgIHNjb3BlLiRkaWdlc3QoKTtcbiAgICAgIC8vICAgICB9LCAzMCoxMDAwKVxuICAgICAgLy8gICB9KVxuICAgICAgLy8gfVxuXG4gICAgICAvLyBzY29wZS5jb3VudEV4YW1wbGVGZWVkYmFjayA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIC8vICAgcmV0dXJuIEZlZWRiYWNrRmFjdG9yeS5jb3VudEZlZWRiYWNrKCdFeGFtcGxlJylcbiAgICAgIC8vICAgLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgLy8gICAgIHNjb3BlLmV4YW1wbGVDb3VudCA9IHJlc3VsdFxuICAgICAgLy8gICB9KVxuICAgICAgLy8gICAudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAvLyAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgIC8vICAgICAgIHNjb3BlLmdyZWF0Q291bnQgPSBudWxsXG4gICAgICAvLyAgICAgICBzY29wZS4kZGlnZXN0KCk7XG4gICAgICAvLyAgICAgfSwgMzAqMTAwMClcbiAgICAgIC8vICAgfSlcbiAgICAgIC8vIH1cblxuICB9XG59XG59KVxuIiwiYXBwLmZhY3RvcnkoJ0ZlZWRiYWNrRmFjdG9yeScsIGZ1bmN0aW9uICgkaHR0cCkge1xuXHR2YXIgRmVlZGJhY2tGYWN0b3J5ID0ge307XG5cblx0RmVlZGJhY2tGYWN0b3J5LmFkZEZlZWRiYWNrID0gZnVuY3Rpb24gKGNhdGVnb3J5KSB7XG5cdFx0cmV0dXJuICRodHRwLnBvc3QoJy9hcGkvZmVlZGJhY2svJywge2NhdGVnb3J5OiBjYXRlZ29yeX0pXG5cdFx0LnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG5cdFx0XHRjb25zb2xlLmxvZygnZ290SEVSRScsIHJlc3VsdClcblx0XHR9KVxuXHR9XG5cblx0RmVlZGJhY2tGYWN0b3J5LmNvdW50RmVlZGJhY2sgPSBmdW5jdGlvbiAoY2F0ZWdvcnkpIHtcblx0XHRyZXR1cm4gJGh0dHAuZ2V0KCcvYXBpL2ZlZWRiYWNrL2NvdW50LycrIGNhdGVnb3J5KVxuXHRcdC50aGVuKGZ1bmN0aW9uKHJlc3VsdCApIHtcblx0XHRcdHJldHVybiByZXN1bHQuZGF0YVxuXHRcdH0pXG5cdH1cblxuXHRyZXR1cm4gRmVlZGJhY2tGYWN0b3J5XG59KSIsImFwcC5kaXJlY3RpdmUoJ3BvbGwnLCAoJHN0YXRlLCBQb2xsRmFjdG9yeSkgPT4ge1xuICByZXR1cm4ge1xuICAgIHJlc3RyaWN0OiAnRScsXG4gICAgc2NvcGU6IHtcbiAgICAgIHVzZUN0cmw6IFwiQFwiXG4gICAgfSxcbiAgICB0ZW1wbGF0ZVVybDogJ2pzL2NvbW1vbi9wb2xsL3BvbGwuaHRtbCcsXG4gICAgbGluazogZnVuY3Rpb24oc2NvcGUpIHtcblxuICAgICAgc2NvcGUuZGVsZXRlID0gUG9sbEZhY3RvcnkuZGVsZXRlUG9sbFxuXG4gICAgICBQb2xsRmFjdG9yeS5nZXRBbGxCeUxlY3R1cmVJZCgxKVxuICAgICAgLnRoZW4oKGN1cnJlbnRQb2xscykgPT4ge1xuICAgICAgICBzY29wZS5wb2xscyA9IGN1cnJlbnRQb2xsc1xuICAgICAgfSlcblxuXG4gICAgfVxuICB9XG59KVxuIiwiYXBwLmZhY3RvcnkoJ1BvbGxGYWN0b3J5JywgKCRodHRwKSA9PiB7XG4gIGZ1bmN0aW9uIGRvdERhdGEoZG90KSB7XG4gICAgcmV0dXJuIGRvdC5kYXRhXG4gIH1cbiAgdmFyIGNhY2hlZFBvbGxzID0gW11cbiAgcmV0dXJuIHtcbiAgICBnZXRBbGxCeUxlY3R1cmVJZDogKGlkKSA9PiB7XG4gICAgICByZXR1cm4gJGh0dHAuZ2V0KCcvYXBpL3BvbGwvbGVjdHVyZS8nK2lkKVxuICAgICAgLnRoZW4oZG90RGF0YSlcbiAgICAgIC50aGVuKChwb2xscykgPT4ge1xuICAgICAgICBhbmd1bGFyLmNvcHkocG9sbHMsIGNhY2hlZFBvbGxzKVxuICAgICAgICByZXR1cm4gY2FjaGVkUG9sbHNcbiAgICAgIH0pXG4gICAgfSxcbiAgICBnZXRPbmVCeVBvbGxJZDogKGlkKSA9PiB7XG4gICAgICByZXR1cm4gJGh0dHAuZ2V0KCcvYXBpL3BvbGwvJytpZClcbiAgICAgIC50aGVuKGRvdERhdGEpXG4gICAgfSxcbiAgICBjcmVhdGVQb2xsOiAocG9sbE9iaikgPT4ge1xuICAgICAgcmV0dXJuICRodHRwLnBvc3QoJy9hcGkvcG9sbC8nLCBwb2xsT2JqKVxuICAgICAgLnRoZW4oZG90RGF0YSlcbiAgICB9LFxuICAgIHVwZGF0ZVBvbGw6IChwb2xsT2JqLCBpZCkgPT4ge1xuICAgICAgcmV0dXJuICRodHRwLnB1dCgnL2FwaS9wb2xsLycraWQsIHBvbGxPYmopXG4gICAgICAudGhlbihkb3REYXRhKVxuICAgIH0sXG4gICAgZGVsZXRlUG9sbDogKGlkKSA9PiB7XG4gICAgICByZXR1cm4gJGh0dHAuZGVsZXRlKCcvYXBpL3BvbGwvJytpZClcbiAgICAgIC50aGVuKGRvdERhdGEpXG4gICAgICAudGhlbigocmVtb3ZlZFBvbGwpID0+IHtcbiAgICAgICAgY2FjaGVkUG9sbHMuc3BsaWNlKGNhY2hlZFBvbGxzLm1hcChmdW5jdGlvbihpdGVtKSB7IHJldHVybiBpdGVtLmlkIH0pLmluZGV4T2YoaWQpLDEpXG4gICAgICAgIHJldHVybiBjYWNoZWRQb2xsc1xuICAgICAgfSlcbiAgICB9XG4gIH1cbn0pXG4iLCJhcHAuZGlyZWN0aXZlKCdxdWVzdGlvbicsIGZ1bmN0aW9uKCRzdGF0ZSwgUXVlc3Rpb25GYWN0b3J5KSB7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICByZXN0cmljdDogJ0UnLFxuICAgICAgICBzY29wZToge1xuICAgICAgICAgICAgXG4gICAgICAgIH0sXG4gICAgICAgIHRlbXBsYXRlVXJsOiAnanMvY29tbW9uL3F1ZXN0aW9uL3F1ZXN0aW9uLmh0bWwnLFxuICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSkge1xuXG4gICAgICAgICAgICBRdWVzdGlvbkZhY3RvcnkuZ2V0QWxsQnlMZWN0dXJlSWQoMSkudGhlbihmdW5jdGlvbihxdWVzdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBzY29wZS5xdWVzdGlvbnMgPSBxdWVzdGlvbnMuZmlsdGVyKGZ1bmN0aW9uKHEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHEuc3RhdHVzID09PSAnb3BlbidcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgZnVuY3Rpb24gZmluZEluZGV4KHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzY29wZS5xdWVzdGlvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNjb3BlLnF1ZXN0aW9uc1tpXS50ZXh0ID09PSBxdWVzdGlvbi50ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZ1bmN0aW9uIG1vdmUocXVlc3Rpb24sIG4pIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kSW5kZXgocXVlc3Rpb24pXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4K24gPiAtMSAmJiBpbmRleCtuIDwgc2NvcGUucXVlc3Rpb25zLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBzY29wZS5xdWVzdGlvbnMuc3BsaWNlKGluZGV4LCAxKVxuICAgICAgICAgICAgICAgICAgICBzY29wZS5xdWVzdGlvbnMuc3BsaWNlKGluZGV4K24sIDAsIHF1ZXN0aW9uKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2NvcGUuc3VibWl0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNjb3BlLm5ld1F1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBxdWVzdGlvbiA9IHt0ZXh0OiBzY29wZS5uZXdRdWVzdGlvbiwgc3VibWl0VGltZTogRGF0ZS5ub3coKSwgdXB2b3RlczogMH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFF1ZXN0aW9uRmFjdG9yeS5zdG9yZShxdWVzdGlvbikudGhlbihmdW5jdGlvbihxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgnYWRkaW5nUXVlc3Rpb24nLCBxKVxuICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUubmV3UXVlc3Rpb24gPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2NvcGUuZGVsZXRlID0gZnVuY3Rpb24ocXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgnZGVsZXRpbmdRdWVzdGlvbicsIHF1ZXN0aW9uKVxuICAgICAgICAgICAgICAgIHJldHVybiBRdWVzdGlvbkZhY3RvcnkuZGVsZXRlKHF1ZXN0aW9uKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzY29wZS5jbG9zZSA9IGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcXVlc3Rpb24uc3RhdHVzID0gJ2Nsb3NlZCdcbiAgICAgICAgICAgICAgICByZXR1cm4gUXVlc3Rpb25GYWN0b3J5LnVwZGF0ZShxdWVzdGlvbikudGhlbihmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgnZGVsZXRpbmdRdWVzdGlvbicsIHF1ZXN0aW9uKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNjb3BlLm1vdmUgPSBmdW5jdGlvbihxdWVzdGlvbiwgbikge1xuICAgICAgICAgICAgICAgIHNvY2tldC5lbWl0KCdtb3ZlJywgcXVlc3Rpb24sIG4pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNjb3BlLnVwdm90ZSA9IGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcXVlc3Rpb24uaGFzVXB2b3RlZCA9ICFxdWVzdGlvbi5oYXNVcHZvdGVkO1xuICAgICAgICAgICAgICAgIHF1ZXN0aW9uLnVwdm90ZXMrKztcbiAgICAgICAgICAgICAgICBzb2NrZXQuZW1pdCgndXB2b3RpbmcnLCBxdWVzdGlvbilcbiAgICAgICAgICAgICAgICByZXR1cm4gUXVlc3Rpb25GYWN0b3J5LnVwZGF0ZShxdWVzdGlvbilcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2NvcGUuZG93bnZvdGUgPSBmdW5jdGlvbihxdWVzdGlvbikge1xuICAgICAgICAgICAgICAgIHF1ZXN0aW9uLmhhc1Vwdm90ZWQgPSAhcXVlc3Rpb24uaGFzVXB2b3RlZDtcbiAgICAgICAgICAgICAgICBxdWVzdGlvbi51cHZvdGVzLS07XG4gICAgICAgICAgICAgICAgc29ja2V0LmVtaXQoJ2Rvd252b3RpbmcnLCBxdWVzdGlvbilcbiAgICAgICAgICAgICAgICByZXR1cm4gUXVlc3Rpb25GYWN0b3J5LnVwZGF0ZShxdWVzdGlvbilcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc29ja2V0Lm9uKCdhZGRRdWVzdGlvbicsIGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG4gICAgICAgICAgICAgICAgc2NvcGUucXVlc3Rpb25zLnVuc2hpZnQocXVlc3Rpb24pXG4gICAgICAgICAgICAgICAgc2NvcGUuJGV2YWxBc3luYygpXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBzb2NrZXQub24oJ2RlbGV0ZVF1ZXN0aW9uJywgZnVuY3Rpb24ocXVlc3Rpb24pIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kSW5kZXgocXVlc3Rpb24pXG4gICAgICAgICAgICAgICAgc2NvcGUucXVlc3Rpb25zLnNwbGljZShpbmRleCwgMSlcbiAgICAgICAgICAgICAgICBzY29wZS4kZXZhbEFzeW5jKClcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIHNvY2tldC5vbigncmVjZWl2ZWRVcHZvdGUnLCBmdW5jdGlvbihxdWVzdGlvbikge1xuICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRJbmRleChxdWVzdGlvbilcbiAgICAgICAgICAgICAgICB2YXIgcXVlc3Rpb24gPSBzY29wZS5xdWVzdGlvbnNbaW5kZXhdXG4gICAgICAgICAgICAgICAgcXVlc3Rpb24udXB2b3RlcysrXG4gICAgICAgICAgICAgICAgc2NvcGUuJGV2YWxBc3luYygpXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBzb2NrZXQub24oJ3JlY2VpdmVkRG93bnZvdGUnLCBmdW5jdGlvbihxdWVzdGlvbikge1xuICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IGZpbmRJbmRleChxdWVzdGlvbilcbiAgICAgICAgICAgICAgICB2YXIgcXVlc3Rpb24gPSBzY29wZS5xdWVzdGlvbnNbaW5kZXhdXG4gICAgICAgICAgICAgICAgcXVlc3Rpb24udXB2b3Rlcy0tO1xuICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsQXN5bmMoKVxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgc29ja2V0Lm9uKCdtb3ZpbmcnLCBmdW5jdGlvbihxdWVzdGlvbiwgbikge1xuICAgICAgICAgICAgICAgIG1vdmUocXVlc3Rpb24sIG4pXG4gICAgICAgICAgICAgICAgc2NvcGUuJGV2YWxBc3luYygpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgfVxufSk7XG4iLCJhcHAuZmFjdG9yeSgnUXVlc3Rpb25GYWN0b3J5JywgZnVuY3Rpb24gKCRodHRwKSB7XG5cblx0dmFyIG9iaiA9IHt9O1xuXG5cdG9iai5nZXRBbGxCeUxlY3R1cmVJZCA9IGZ1bmN0aW9uKGxlY3R1cmVJZCkge1xuXHRcdHJldHVybiAkaHR0cC5nZXQoJy9hcGkvcXVlc3Rpb24vbGVjdHVyZS8nICsgbGVjdHVyZUlkKS50aGVuKGZ1bmN0aW9uKHJlcykge1xuXHRcdFx0cmV0dXJuIHJlcy5kYXRhO1xuXHRcdH0pXG5cdH1cblxuXHRvYmouc3RvcmUgPSBmdW5jdGlvbihxdWVzdGlvbikge1xuXHRcdHJldHVybiAkaHR0cC5wb3N0KCcvYXBpL3F1ZXN0aW9uJywgcXVlc3Rpb24pLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG5cdFx0XHRyZXR1cm4gcmVzLmRhdGE7XG5cdFx0fSlcblx0fVxuXG5cdG9iai51cGRhdGUgPSBmdW5jdGlvbihxdWVzdGlvbikge1xuXHRcdHJldHVybiAkaHR0cC5wdXQoJy9hcGkvcXVlc3Rpb24vJyArIHF1ZXN0aW9uLmlkLCBxdWVzdGlvbikudGhlbihmdW5jdGlvbihyZXMpIHtcblx0XHRcdHJldHVybiByZXMuZGF0YTtcblx0XHR9KVxuXHR9XG5cblx0b2JqLmRlbGV0ZSA9IGZ1bmN0aW9uKHF1ZXN0aW9uKSB7XG5cdFx0cmV0dXJuICRodHRwLmRlbGV0ZSgnL2FwaS9xdWVzdGlvbi8nICsgcXVlc3Rpb24uaWQpLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG5cdFx0XHRyZXR1cm4gcmVzLmRhdGE7XG5cdFx0fSlcblx0fVxuXG5cdHJldHVybiBvYmo7XG5cbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
